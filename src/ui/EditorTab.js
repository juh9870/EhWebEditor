"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EditorTab = void 0;
const $ = require("jquery");
const types_1 = require("../types");
const schema_1 = require("../schema/schema");
const utils_1 = require("../utils");
const database_1 = require("../database");
require("select2");
const JSONEditor = require("@json-editor/json-editor").JSONEditor;
// declare global {
//     const JSONEditor:any;
// }
let swr = (obj, r) => {
    for (let key of Object.getOwnPropertyNames(obj)) {
        let val = obj[key];
        if (r && (key.startsWith("$") || val === database_1.Database.deleteNumber)) {
            delete obj[key];
            continue;
        }
        if (typeof val === "string") {
            if (val.match(/^#[0-9a-fA-F]{8}$/)) {
                let split = val.match(/[0-9a-fA-F]{2}/g);
                if (r) {
                    split.unshift(split.pop());
                }
                else {
                    split.push(split.shift());
                }
                obj[key] = "#" + split.join("");
            }
        }
        else if (val && typeof val === "object" || Array.isArray(val)) {
            swr(val, r);
        }
    }
    return obj;
};
let editors = window.editors = {};
let holders = {};
let current = types_1.ItemType.Undefined;
let curData;
let database;
let root;
let ready = false;
let readyAwaiters = [];
// debugger;
JSONEditor.defaults.callbacks.template = {};
for (let type of utils_1.values(types_1.ItemTypesMap)) {
    let keyT = type + "_EnumTitleCB";
    let keyV = type + "_EnumValueCB";
    JSONEditor.defaults.callbacks.template[keyT] = (jseditor, e) => {
        if (e.item === database_1.Database.deleteNumber)
            return "None";
        return database.mappings[type][e.item].path;
    };
    JSONEditor.defaults.callbacks.template[keyV] = (jseditor, e) => {
        return e.item;
    };
}
class EditorTab {
    static async init(_database) {
        database = _database;
        root = $("#contentHolder");
        for (let editor of utils_1.values(editors)) {
            editor.destroy();
        }
        holders = {};
        root.empty();
        for (let type of utils_1.values(types_1.ItemTypesMap)) {
        }
        EditorTab.closeAll();
    }
    static closeAll() {
        for (let type of utils_1.values(types_1.ItemTypesMap)) {
            EditorTab.close(type);
        }
    }
    static close(type) {
        var _a;
        // editors[type].disable();
        // holders[type].hide();
        (_a = editors[type]) === null || _a === void 0 ? void 0 : _a.destroy();
    }
    static show(type) {
        EditorTab.close(current);
        current = type;
        let typeSchema = schema_1.schemaForType(type, database);
        let holder = $(`<div id="editor_holder" data-theme="html"></div>`);
        root.append(holder);
        holders[type] = holder;
        ready = false;
        editors[type] = new JSONEditor(holder[0], {
            schema: typeSchema,
            "template": "default",
            "show_errors": "always",
            "required_by_default": 1,
            "show_opt_in": 1,
            "disable_properties": 1,
            "enable_array_copy": 1,
            "disable_array_delete_all_rows": 1,
            "disable_array_delete_last_row": 1,
            "prompt_before_delete": 1
        });
        editors[current].on("ready", () => {
            ready = true;
            for (let readyAwaiter of readyAwaiters) {
                readyAwaiter();
            }
        });
        // editors[type].enable();
        holders[type].show();
    }
    static feedData(data) {
        let type = data.ItemType;
        EditorTab.show(type);
        editors[current].setValue({});
        // let hold = $(editors[current].element);
        // let inp = hold.find(".je-switcher")[0] as HTMLSelectElement;
        // inp.value=ItemTypesMapRev[type];
        // let ev = new Event('change');
        // inp.dispatchEvent(ev);
        curData = swr(utils_1.clone(data), false);
        EditorTab.populateTech(curData);
        editors[current].setValue(curData);
    }
    static async getData() {
        await EditorTab.waitTillReady();
        let data = editors[current].getValue();
        data = swr(utils_1.clone(data), true);
        EditorTab.depopulateTech(data);
        return data;
    }
    static waitTillReady() {
        if (ready) {
            return Promise.resolve();
        }
        return new Promise((resolve, reject) => {
            readyAwaiters.push(resolve);
        });
    }
    static populateTech(targ) {
        if (targ.ItemType == types_1.ItemType.Component) {
            targ.AmmunitionIdObsolete = targ.AmmunitionId;
        }
    }
    static depopulateTech(targ) {
        var _a;
        if (targ.ItemType == types_1.ItemType.Component) {
            targ.AmmunitionId = (_a = targ.AmmunitionId) !== null && _a !== void 0 ? _a : targ.AmmunitionIdObsolete;
            delete targ.AmmunitionIdObsolete;
        }
    }
}
exports.EditorTab = EditorTab;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRWRpdG9yVGFiLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRWRpdG9yVGFiLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDRCQUE0QjtBQUM1QixvQ0FBeUU7QUFDekUsNkNBQStDO0FBQy9DLG9DQUF1QztBQUN2QywwQ0FBcUM7QUFFckMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRW5CLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLFVBQVUsQ0FBQztBQUNsRSxtQkFBbUI7QUFDbkIsNEJBQTRCO0FBQzVCLElBQUk7QUFFSixJQUFJLEdBQUcsR0FBRyxDQUFDLEdBQVEsRUFBRSxDQUFVLEVBQUUsRUFBRTtJQUMvQixLQUFLLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUM3QyxJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsS0FBSyxtQkFBUSxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQzdELE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2hCLFNBQVM7U0FDWjtRQUNELElBQUksT0FBTyxHQUFHLEtBQUssUUFBUSxFQUFFO1lBQ3pCLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO2dCQUNoQyxJQUFJLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFhLENBQUM7Z0JBQ3JELElBQUksQ0FBQyxFQUFFO29CQUNILEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBWSxDQUFDLENBQUM7aUJBQ3hDO3FCQUFNO29CQUNILEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBWSxDQUFDLENBQUM7aUJBQ3ZDO2dC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O0lBQ08sTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFTOztRQUNuQyxJQUFHLElBQUksQ0FBQyxRQUFRLElBQUUsZ0JBQVEsQ0FBQyxTQUFTLEVBQUM7WUFDakMsSUFBSSxDQUFDLFlBQVksR0FBQyxNQUFBLElBQUksQ0FBQyxZQUFZLG1DQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztZQUMvRCxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztTQUNwQztJQUNMLENBQUM7Q0FDSjtBQXZHRCw4QkF1R0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyAkIGZyb20gXCJqcXVlcnlcIjtcclxuaW1wb3J0IHtEYXRhYmFzZUZpbGUsIEl0ZW1UeXBlLCBJdGVtVHlwZXNNYXAsIE51bWJlck1hcH0gZnJvbSBcIi4uL3R5cGVzXCI7XHJcbmltcG9ydCB7c2NoZW1hRm9yVHlwZX0gZnJvbSBcIi4uL3NjaGVtYS9zY2hlbWFcIjtcclxuaW1wb3J0IHtjbG9uZSwgdmFsdWVzfSBmcm9tIFwiLi4vdXRpbHNcIjtcclxuaW1wb3J0IHtEYXRhYmFzZX0gZnJvbSBcIi4uL2RhdGFiYXNlXCI7XHJcblxyXG5yZXF1aXJlKFwic2VsZWN0MlwiKTtcclxuXHJcbmNvbnN0IEpTT05FZGl0b3IgPSByZXF1aXJlKFwiQGpzb24tZWRpdG9yL2pzb24tZWRpdG9yXCIpLkpTT05FZGl0b3I7XHJcbi8vIGRlY2xhcmUgZ2xvYmFsIHtcclxuLy8gICAgIGNvbnN0IEpTT05FZGl0b3I6YW55O1xyXG4vLyB9XHJcblxyXG5sZXQgc3dyID0gKG9iajogYW55LCByOiBib29sZWFuKSA9PiB7XHJcbiAgICBmb3IgKGxldCBrZXkgb2YgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMob2JqKSkge1xyXG4gICAgICAgIGxldCB2YWwgPSBvYmpba2V5XTtcclxuICAgICAgICBpZiAociAmJiAoa2V5LnN0YXJ0c1dpdGgoXCIkXCIpIHx8IHZhbCA9PT0gRGF0YWJhc2UuZGVsZXRlTnVtYmVyKSkge1xyXG4gICAgICAgICAgICBkZWxldGUgb2JqW2tleV07XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICBpZiAodmFsLm1hdGNoKC9eI1swLTlhLWZBLUZdezh9JC8pKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgc3BsaXQgPSB2YWwubWF0Y2goL1swLTlhLWZBLUZdezJ9L2cpIGFzIHN0cmluZ1tdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzcGxpdC51bnNoaWZ0KHNwbGl0LnBvcCgpIGFzIHN0cmluZyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHNwbGl0LnB1c2goc3BsaXQuc2hpZnQoKSBhcyBzdHJpbmcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgb2JqW2tleV0gPSBcIiNcIiArIHNwbGl0LmpvaW4oXCJcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKHZhbCAmJiB0eXBlb2YgdmFsID09PSBcIm9iamVjdFwiIHx8IEFycmF5LmlzQXJyYXkodmFsKSkge1xyXG4gICAgICAgICAgICBzd3IodmFsLCByKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gb2JqO1xyXG59XHJcblxyXG5sZXQgZWRpdG9yczogTnVtYmVyTWFwPEpTT05FZGl0b3I+ID0gKHdpbmRvdyBhcyBhbnkpLmVkaXRvcnMgPSB7fTtcclxubGV0IGhvbGRlcnM6IE51bWJlck1hcDxKUXVlcnk8SFRNTEVsZW1lbnQ+PiA9IHt9O1xyXG5sZXQgY3VycmVudDogSXRlbVR5cGUgPSBJdGVtVHlwZS5VbmRlZmluZWQ7XHJcbmxldCBjdXJEYXRhOiBvYmplY3Q7XHJcbmxldCBkYXRhYmFzZTogRGF0YWJhc2U7XHJcbmxldCByb290OiBKUXVlcnk8SFRNTEVsZW1lbnQ+O1xyXG5sZXQgcmVhZHk9ZmFsc2U7XHJcbmxldCByZWFkeUF3YWl0ZXJzOigoLi4uYXJnczphbnlbXSk9PnZvaWQpW10gPSBbXVxyXG5cclxuLy8gZGVidWdnZXI7XHJcblxyXG5KU09ORWRpdG9yLmRlZmF1bHRzLmNhbGxiYWNrcy50ZW1wbGF0ZSA9IHt9XHJcbmZvciAobGV0IHR5cGUgb2YgdmFsdWVzKEl0ZW1UeXBlc01hcCkpIHtcclxuICAgIGxldCBrZXlUID0gdHlwZSArIFwiX0VudW1UaXRsZUNCXCI7XHJcbiAgICBsZXQga2V5ViA9IHR5cGUgKyBcIl9FbnVtVmFsdWVDQlwiO1xyXG5cclxuICAgIEpTT05FZGl0b3IuZGVmYXVsdHMuY2FsbGJhY2tzLnRlbXBsYXRlW2tleVRdID0gKGpzZWRpdG9yOiBhbnksIGU6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmKGUuaXRlbT09PURhdGFiYXNlLmRlbGV0ZU51bWJlcilyZXR1cm4gXCJOb25lXCJcclxuICAgICAgICByZXR1cm4gZGF0YWJhc2UubWFwcGluZ3NbdHlwZV1bZS5pdGVtXS5wYXRoO1xyXG5cclxuICAgIH07XHJcbiAgICBKU09ORWRpdG9yLmRlZmF1bHRzLmNhbGxiYWNrcy50ZW1wbGF0ZVtrZXlWXSA9IChqc2VkaXRvcjogYW55LCBlOiBhbnkpID0+IHtcclxuICAgICAgICByZXR1cm4gZS5pdGVtO1xyXG4gICAgfTtcclxuXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBFZGl0b3JUYWIge1xyXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBpbml0KF9kYXRhYmFzZTogRGF0YWJhc2UpIHtcclxuICAgICAgICBkYXRhYmFzZSA9IF9kYXRhYmFzZTtcclxuICAgICAgICByb290ID0gJChcIiNjb250ZW50SG9sZGVyXCIpO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBlZGl0b3Igb2YgdmFsdWVzKGVkaXRvcnMpKSB7XHJcbiAgICAgICAgICAgIGVkaXRvci5kZXN0cm95KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGhvbGRlcnMgPSB7fTtcclxuICAgICAgICByb290LmVtcHR5KCk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IHR5cGUgb2YgdmFsdWVzKEl0ZW1UeXBlc01hcCkpIHtcclxuICAgICAgICB9XHJcbiAgICAgICAgRWRpdG9yVGFiLmNsb3NlQWxsKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBjbG9zZUFsbCgpIHtcclxuICAgICAgICBmb3IgKGxldCB0eXBlIG9mIHZhbHVlcyhJdGVtVHlwZXNNYXApKSB7XHJcbiAgICAgICAgICAgIEVkaXRvclRhYi5jbG9zZSh0eXBlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBjbG9zZSh0eXBlOiBJdGVtVHlwZSkge1xyXG4gICAgICAgIC8vIGVkaXRvcnNbdHlwZV0uZGlzYWJsZSgpO1xyXG4gICAgICAgIC8vIGhvbGRlcnNbdHlwZV0uaGlkZSgpO1xyXG4gICAgICAgIGVkaXRvcnNbdHlwZV0/LmRlc3Ryb3koKVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgc2hvdyh0eXBlOiBJdGVtVHlwZSkge1xyXG4gICAgICAgIEVkaXRvclRhYi5jbG9zZShjdXJyZW50KTtcclxuICAgICAgICBjdXJyZW50ID0gdHlwZTtcclxuXHJcblxyXG4gICAgICAgIGxldCB0eXBlU2NoZW1hID0gc2NoZW1hRm9yVHlwZSh0eXBlLCBkYXRhYmFzZSk7XHJcbiAgICAgICAgbGV0IGhvbGRlciA9ICQoYDxkaXYgaWQ9XCJlZGl0b3JfaG9sZGVyXCIgZGF0YS10aGVtZT1cImh0bWxcIj48L2Rpdj5gKTtcclxuICAgICAgICByb290LmFwcGVuZChob2xkZXIpO1xyXG4gICAgICAgIGhvbGRlcnNbdHlwZV0gPSBob2xkZXI7XHJcbiAgICAgICAgcmVhZHk9ZmFsc2U7XHJcbiAgICAgICAgZWRpdG9yc1t0eXBlXSA9IG5ldyBKU09ORWRpdG9yKGhvbGRlclswXSwge1xyXG4gICAgICAgICAgICBzY2hlbWE6IHR5cGVTY2hlbWEsXHJcbiAgICAgICAgICAgIFwidGVtcGxhdGVcIjogXCJkZWZhdWx0XCIsXHJcbiAgICAgICAgICAgIFwic2hvd19lcnJvcnNcIjogXCJhbHdheXNcIixcclxuICAgICAgICAgICAgXCJyZXF1aXJlZF9ieV9kZWZhdWx0XCI6IDEsXHJcbiAgICAgICAgICAgIFwic2hvd19vcHRfaW5cIjogMSxcclxuICAgICAgICAgICAgXCJkaXNhYmxlX3Byb3BlcnRpZXNcIjogMSxcclxuICAgICAgICAgICAgXCJlbmFibGVfYXJyYXlfY29weVwiOiAxLFxyXG4gICAgICAgICAgICBcImRpc2FibGVfYXJyYXlfZGVsZXRlX2FsbF9yb3dzXCI6IDEsXHJcbiAgICAgICAgICAgIFwiZGlzYWJsZV9hcnJheV9kZWxldGVfbGFzdF9yb3dcIjogMSxcclxuICAgICAgICAgICAgXCJwcm9tcHRfYmVmb3JlX2RlbGV0ZVwiOiAxXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZWRpdG9yc1tjdXJyZW50XS5vbihcInJlYWR5XCIsKCk9PiB7XHJcbiAgICAgICAgICAgIHJlYWR5PXRydWU7XHJcbiAgICAgICAgICAgIGZvciAobGV0IHJlYWR5QXdhaXRlciBvZiByZWFkeUF3YWl0ZXJzKSB7XHJcbiAgICAgICAgICAgICAgICByZWFkeUF3YWl0ZXIoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gZWRpdG9yc1t0eXBlXS5lbmFibGUoKTtcclxuICAgICAgICBob2xkZXJzW3R5cGVdLnNob3coKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGZlZWREYXRhKGRhdGE6IERhdGFiYXNlRmlsZSkge1xyXG4gICAgICAgIGxldCB0eXBlID0gZGF0YS5JdGVtVHlwZTtcclxuICAgICAgICBFZGl0b3JUYWIuc2hvdyh0eXBlKTtcclxuICAgICAgICBlZGl0b3JzW2N1cnJlbnRdLnNldFZhbHVlKHt9KTtcclxuICAgICAgICAvLyBsZXQgaG9sZCA9ICQoZWRpdG9yc1tjdXJyZW50XS5lbGVtZW50KTtcclxuICAgICAgICAvLyBsZXQgaW5wID0gaG9sZC5maW5kKFwiLmplLXN3aXRjaGVyXCIpWzBdIGFzIEhUTUxTZWxlY3RFbGVtZW50O1xyXG4gICAgICAgIC8vIGlucC52YWx1ZT1JdGVtVHlwZXNNYXBSZXZbdHlwZV07XHJcbiAgICAgICAgLy8gbGV0IGV2ID0gbmV3IEV2ZW50KCdjaGFuZ2UnKTtcclxuICAgICAgICAvLyBpbnAuZGlzcGF0Y2hFdmVudChldik7XHJcbiAgICAgICAgY3VyRGF0YSA9IHN3cihjbG9uZShkYXRhKSwgZmFsc2UpO1xyXG4gICAgICAgIEVkaXRvclRhYi5wb3B1bGF0ZVRlY2goY3VyRGF0YSk7XHJcbiAgICAgICAgZWRpdG9yc1tjdXJyZW50XS5zZXRWYWx1ZShjdXJEYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGdldERhdGEoKSB7XHJcbiAgICAgICAgYXdhaXQgRWRpdG9yVGFiLndhaXRUaWxsUmVhZHkoKTtcclxuICAgICAgICBsZXQgZGF0YSA9IGVkaXRvcnNbY3VycmVudF0uZ2V0VmFsdWUoKTtcclxuICAgICAgICBkYXRhPXN3cihjbG9uZShkYXRhKSwgdHJ1ZSlcclxuICAgICAgICBFZGl0b3JUYWIuZGVwb3B1bGF0ZVRlY2goZGF0YSk7XHJcbiAgICAgICAgcmV0dXJuIGRhdGEgYXMgRGF0YWJhc2VGaWxlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIHdhaXRUaWxsUmVhZHkoKXtcclxuICAgICAgICBpZihyZWFkeSl7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUscmVqZWN0KT0+e1xyXG4gICAgICAgICAgICByZWFkeUF3YWl0ZXJzLnB1c2gocmVzb2x2ZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcG9wdWxhdGVUZWNoKHRhcmc6IGFueSkge1xyXG4gICAgICAgIGlmKHRhcmcuSXRlbVR5cGU9PUl0ZW1UeXBlLkNvbXBvbmVudCl7XHJcbiAgICAgICAgICAgIHRhcmcuQW1tdW5pdGlvbklkT2Jzb2xldGU9dGFyZy5BbW11bml0aW9uSWQ7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZGVwb3B1bGF0ZVRlY2godGFyZzogYW55KSB7XHJcbiAgICAgICAgaWYodGFyZy5JdGVtVHlwZT09SXRlbVR5cGUuQ29tcG9uZW50KXtcclxuICAgICAgICAgICAgdGFyZy5BbW11bml0aW9uSWQ9dGFyZy5BbW11bml0aW9uSWQ/P3RhcmcuQW1tdW5pdGlvbklkT2Jzb2xldGU7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0YXJnLkFtbXVuaXRpb25JZE9ic29sZXRlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSJdfQ==