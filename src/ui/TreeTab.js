"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TreeTab = void 0;
const $ = require("jquery");
const EditorTab_1 = require("./EditorTab");
const equal = require("deep-equal");
require("jstree");
let treeBase;
let tree;
let curPath = "";
let prevData;
let eventLocked = false;
let to;
let folderInput;
let saveButton;
let searchInput;
class TreeTab {
    static init(files, database) {
        TreeTab.files = files;
        TreeTab.database = database;
        let holder = $("#treeHolder");
        let r1 = $("<div class='r1'></div>");
        let r2 = $("<div class='r2'></div>");
        holder.append(r1);
        holder.append(r2);
        folderInput = $(`<input type="file" webkitdirectory multiple>`);
        saveButton = $(`<input type="button" value="Save database">`);
        let searchLabel = $(`<label for="tree-search">Search: </label>`);
        searchInput = $(`<input id="tree-search" type="search">`);
        r1.append(folderInput);
        r1.append(saveButton);
        r2.append(searchLabel);
        r2.append(searchInput);
        saveButton.prop("disabled", true);
        searchInput.prop("disabled", true);
        treeBase = $(`<div></div>`);
        holder.append(treeBase);
        holder.on("change", async (event) => {
            if (eventLocked)
                return;
            eventLocked = true;
            let _files = Array.from(folderInput[0].files);
            await TreeTab.files.init(_files);
            await TreeTab.redrawTree();
            eventLocked = false;
        });
        saveButton.on('click', async () => {
            if (eventLocked)
                return;
            eventLocked = true;
            await TreeTab.save();
            await TreeTab.files.save();
            eventLocked = false;
        });
        searchInput.on('keyup', () => {
            if (!tree)
                return;
            if (to)
                clearTimeout(to);
            to = setTimeout(function () {
                let v = searchInput.val();
                tree.search(v);
            }, 250);
        });
    }
    static async redrawTree() {
        if (tree)
            tree.destroy(false);
        saveButton.prop("disabled", true);
        searchInput.prop("disabled", true);
        tree = treeBase.jstree({
            core: {
                data: await TreeTab.files.treeData(),
                error: console.error,
                multiple: false,
            },
            types: {
                json: {
                    icon: "assets/json.png",
                    max_children: 0
                }
            },
            search: {
                show_only_matches: true,
                show_only_matches_children: true
            },
            plugins: ["search", "types", "wholerow"]
        }).jstree(true);
        TreeTab.createEvents();
        saveButton.prop("disabled", false);
        searchInput.prop("disabled", false);
    }
    static async save() {
        if (!curPath.length)
            return;
        let curData = EditorTab_1.EditorTab.getData();
        if (!equal(curData, prevData, { strict: true })) {
            if (!await TreeTab.database.tryApplyChanges(prevData, curData)) {
                return;
            }
            let curDataStr = JSON.stringify(curData);
            await TreeTab.files.writeFile(curPath, curDataStr);
        }
    }
    static createEvents() {
        treeBase.on('changed.jstree', async function (e, data) {
            var _a;
            if (eventLocked)
                return;
            if (((_a = data === null || data === void 0 ? void 0 : data.node) === null || _a === void 0 ? void 0 : _a.type) !== "json")
                return;
            eventLocked = true;
            await TreeTab.save();
            curPath = await TreeTab.files.getPathFromSelection(data.selected);
            let selected = await TreeTab.files.readFile(curPath);
            prevData = JSON.parse(selected);
            EditorTab_1.EditorTab.feedData(prevData);
            eventLocked = false;
        });
    }
}
exports.TreeTab = TreeTab;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHJlZVRhYi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlRyZWVUYWIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNEJBQTRCO0FBRTVCLDJDQUFzQztBQUd0QyxvQ0FBcUM7QUFFckMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRWxCLElBQUksUUFBZ0IsQ0FBQTtBQUNwQixJQUFJLElBQVksQ0FBQztBQUNqQixJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFDakIsSUFBSSxRQUFzQixDQUFDO0FBQzNCLElBQUksV0FBVyxHQUFHLEtBQUssQ0FBQztBQUN4QixJQUFJLEVBQU8sQ0FBQztBQUNaLElBQUksV0FBcUMsQ0FBQztBQUMxQyxJQUFJLFVBQW9DLENBQUM7QUFDekMsSUFBSSxXQUFxQyxDQUFDO0FBRTFDLE1BQWEsT0FBTztJQUlULE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBWSxFQUFFLFFBQWtCO1FBQy9DLE9BQU8sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLE9BQU8sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQzVCLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUM5QixJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQztRQUNyQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQztRQUNyQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xCLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbEIsV0FBVyxHQUFHLENBQUMsQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO1FBQ2hFLFVBQVUsR0FBRyxDQUFDLENBQUMsNkNBQTZDLENBQUMsQ0FBQztRQUM5RCxJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUMsMkNBQTJDLENBQUMsQ0FBQTtRQUNoRSxXQUFXLEdBQUcsQ0FBQyxDQUFDLHdDQUF3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LG9CQUFvQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNsRSxJQUFJLFFBQVEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3JELFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2hDLHFCQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzdCLFdBQVcsR0FBRyxLQUFLLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUF0R0QsMEJBc0dDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgJCBmcm9tIFwianF1ZXJ5XCI7XHJcbmltcG9ydCB7RmlsZXN9IGZyb20gXCIuLi9maWxlc1wiO1xyXG5pbXBvcnQge0VkaXRvclRhYn0gZnJvbSBcIi4vRWRpdG9yVGFiXCI7XHJcbmltcG9ydCB7RGF0YWJhc2VGaWxlfSBmcm9tIFwiLi4vdHlwZXNcIjtcclxuaW1wb3J0IHtEYXRhYmFzZX0gZnJvbSBcIi4uL2RhdGFiYXNlXCI7XHJcbmltcG9ydCBlcXVhbCA9IHJlcXVpcmUoXCJkZWVwLWVxdWFsXCIpO1xyXG5cclxucmVxdWlyZShcImpzdHJlZVwiKTtcclxuXHJcbmxldCB0cmVlQmFzZTogSlF1ZXJ5XHJcbmxldCB0cmVlOiBKU1RyZWU7XHJcbmxldCBjdXJQYXRoID0gXCJcIjtcclxubGV0IHByZXZEYXRhOiBEYXRhYmFzZUZpbGU7XHJcbmxldCBldmVudExvY2tlZCA9IGZhbHNlO1xyXG5sZXQgdG86IGFueTtcclxubGV0IGZvbGRlcklucHV0OiBKUXVlcnk8SFRNTElucHV0RWxlbWVudD47XHJcbmxldCBzYXZlQnV0dG9uOiBKUXVlcnk8SFRNTElucHV0RWxlbWVudD47XHJcbmxldCBzZWFyY2hJbnB1dDogSlF1ZXJ5PEhUTUxJbnB1dEVsZW1lbnQ+O1xyXG5cclxuZXhwb3J0IGNsYXNzIFRyZWVUYWIge1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZmlsZXM6IEZpbGVzO1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZGF0YWJhc2U6IERhdGFiYXNlO1xyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgaW5pdChmaWxlczogRmlsZXMsIGRhdGFiYXNlOiBEYXRhYmFzZSkge1xyXG4gICAgICAgIFRyZWVUYWIuZmlsZXMgPSBmaWxlcztcclxuICAgICAgICBUcmVlVGFiLmRhdGFiYXNlID0gZGF0YWJhc2U7XHJcbiAgICAgICAgbGV0IGhvbGRlciA9ICQoXCIjdHJlZUhvbGRlclwiKTtcclxuICAgICAgICBsZXQgcjEgPSAkKFwiPGRpdiBjbGFzcz0ncjEnPjwvZGl2PlwiKTtcclxuICAgICAgICBsZXQgcjIgPSAkKFwiPGRpdiBjbGFzcz0ncjInPjwvZGl2PlwiKTtcclxuICAgICAgICBob2xkZXIuYXBwZW5kKHIxKTtcclxuICAgICAgICBob2xkZXIuYXBwZW5kKHIyKTtcclxuICAgICAgICBmb2xkZXJJbnB1dCA9ICQoYDxpbnB1dCB0eXBlPVwiZmlsZVwiIHdlYmtpdGRpcmVjdG9yeSBtdWx0aXBsZT5gKTtcclxuICAgICAgICBzYXZlQnV0dG9uID0gJChgPGlucHV0IHR5cGU9XCJidXR0b25cIiB2YWx1ZT1cIlNhdmUgZGF0YWJhc2VcIj5gKTtcclxuICAgICAgICBsZXQgc2VhcmNoTGFiZWwgPSAkKGA8bGFiZWwgZm9yPVwidHJlZS1zZWFyY2hcIj5TZWFyY2g6IDwvbGFiZWw+YClcclxuICAgICAgICBzZWFyY2hJbnB1dCA9ICQoYDxpbnB1dCBpZD1cInRyZWUtc2VhcmNoXCIgdHlwZT1cInNlYXJjaFwiPmApO1xyXG4gICAgICAgIHIxLmFwcGVuZChmb2xkZXJJbnB1dCk7XHJcbiAgICAgICAgcjEuYXBwZW5kKHNhdmVCdXR0b24pO1xyXG4gICAgICAgIHIyLmFwcGVuZChzZWFyY2hMYWJlbCk7XHJcbiAgICAgICAgcjIuYXBwZW5kKHNlYXJjaElucHV0KTtcclxuICAgICAgICBzYXZlQnV0dG9uLnByb3AoXCJkaXNhYmxlZFwiLHRydWUpO1xyXG4gICAgICAgIHNlYXJjaElucHV0LnByb3AoXCJkaXNhYmxlZFwiLHRydWUpO1xyXG4gICAgICAgIHRyZWVCYXNlID0gJChgPGRpdj48L2Rpdj5gKTtcclxuICAgICAgICBob2xkZXIuYXBwZW5kKHRyZWVCYXNlKTtcclxuICAgICAgICBob2xkZXIub24oXCJjaGFuZ2VcIiwgYXN5bmMgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChldmVudExvY2tlZCkgcmV0dXJuO1xyXG4gICAgICAgICAgICBldmVudExvY2tlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIGxldCBfZmlsZXMgPSBBcnJheS5mcm9tKGZvbGRlcklucHV0WzBdLmZpbGVzIGFzIEZpbGVMaXN0KTtcclxuICAgICAgICAgICAgYXdhaXQgVHJlZVRhYi5maWxlcy5pbml0KF9maWxlcyk7XHJcbiAgICAgICAgICAgIGF3YWl0IFRyZWVUYWIucmVkcmF3VHJlZSgpO1xyXG4gICAgICAgICAgICBldmVudExvY2tlZCA9IGZhbHNlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNhdmVCdXR0b24ub24oJ2NsaWNrJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnRMb2NrZWQpIHJldHVybjtcclxuICAgICAgICAgICAgZXZlbnRMb2NrZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBhd2FpdCBUcmVlVGFiLnNhdmUoKTtcclxuICAgICAgICAgICAgYXdhaXQgVHJlZVRhYi5maWxlcy5zYXZlKCk7XHJcbiAgICAgICAgICAgIGV2ZW50TG9ja2VkID0gZmFsc2U7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgc2VhcmNoSW5wdXQub24oJ2tleXVwJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXRyZWUpIHJldHVybjtcclxuICAgICAgICAgICAgaWYgKHRvKSBjbGVhclRpbWVvdXQodG8pO1xyXG4gICAgICAgICAgICB0byA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IHYgPSBzZWFyY2hJbnB1dC52YWwoKSBhcyBzdHJpbmc7XHJcbiAgICAgICAgICAgICAgICB0cmVlLnNlYXJjaCh2KTtcclxuICAgICAgICAgICAgfSwgMjUwKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIHJlZHJhd1RyZWUoKSB7XHJcbiAgICAgICAgaWYgKHRyZWUpIHRyZWUuZGVzdHJveShmYWxzZSk7XHJcbiAgICAgICAgc2F2ZUJ1dHRvbi5wcm9wKFwiZGlzYWJsZWRcIix0cnVlKTtcclxuICAgICAgICBzZWFyY2hJbnB1dC5wcm9wKFwiZGlzYWJsZWRcIix0cnVlKTtcclxuICAgICAgICB0cmVlID0gdHJlZUJhc2UuanN0cmVlKHtcclxuICAgICAgICAgICAgY29yZToge1xyXG4gICAgICAgICAgICAgICAgZGF0YTogYXdhaXQgVHJlZVRhYi5maWxlcy50cmVlRGF0YSgpLFxyXG4gICAgICAgICAgICAgICAgZXJyb3I6IGNvbnNvbGUuZXJyb3IsXHJcbiAgICAgICAgICAgICAgICBtdWx0aXBsZTogZmFsc2UsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHR5cGVzOiB7XHJcbiAgICAgICAgICAgICAgICBqc29uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWNvbjogXCJhc3NldHMvanNvbi5wbmdcIixcclxuICAgICAgICAgICAgICAgICAgICBtYXhfY2hpbGRyZW46IDBcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc2VhcmNoOntcclxuICAgICAgICAgICAgICAgIHNob3dfb25seV9tYXRjaGVzOnRydWUsXHJcbiAgICAgICAgICAgICAgICBzaG93X29ubHlfbWF0Y2hlc19jaGlsZHJlbjp0cnVlXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHBsdWdpbnM6IFtcInNlYXJjaFwiLCBcInR5cGVzXCIsIFwid2hvbGVyb3dcIl1cclxuICAgICAgICB9IGFzIEpTVHJlZVN0YXRpY0RlZmF1bHRzKS5qc3RyZWUodHJ1ZSk7XHJcbiAgICAgICAgVHJlZVRhYi5jcmVhdGVFdmVudHMoKTtcclxuICAgICAgICBzYXZlQnV0dG9uLnByb3AoXCJkaXNhYmxlZFwiLGZhbHNlKTtcclxuICAgICAgICBzZWFyY2hJbnB1dC5wcm9wKFwiZGlzYWJsZWRcIixmYWxzZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBzYXZlKCkge1xyXG4gICAgICAgIGlmICghY3VyUGF0aC5sZW5ndGgpIHJldHVybjtcclxuICAgICAgICBsZXQgY3VyRGF0YTogRGF0YWJhc2VGaWxlID0gRWRpdG9yVGFiLmdldERhdGEoKTtcclxuXHJcbiAgICAgICAgaWYgKCFlcXVhbChjdXJEYXRhLCBwcmV2RGF0YSwge3N0cmljdDogdHJ1ZX0pKSB7XHJcbiAgICAgICAgICAgIGlmICghYXdhaXQgVHJlZVRhYi5kYXRhYmFzZS50cnlBcHBseUNoYW5nZXMocHJldkRhdGEsIGN1ckRhdGEpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGV0IGN1ckRhdGFTdHIgPSBKU09OLnN0cmluZ2lmeShjdXJEYXRhKTtcclxuICAgICAgICAgICAgYXdhaXQgVHJlZVRhYi5maWxlcy53cml0ZUZpbGUoY3VyUGF0aCwgY3VyRGF0YVN0cik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlRXZlbnRzKCkge1xyXG4gICAgICAgIHRyZWVCYXNlLm9uKCdjaGFuZ2VkLmpzdHJlZScsIGFzeW5jIGZ1bmN0aW9uIChlLCBkYXRhKSB7XHJcbiAgICAgICAgICAgIGlmIChldmVudExvY2tlZCkgcmV0dXJuO1xyXG4gICAgICAgICAgICBpZiAoZGF0YT8ubm9kZT8udHlwZSAhPT0gXCJqc29uXCIpIHJldHVybjtcclxuICAgICAgICAgICAgZXZlbnRMb2NrZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBhd2FpdCBUcmVlVGFiLnNhdmUoKTtcclxuICAgICAgICAgICAgY3VyUGF0aCA9IGF3YWl0IFRyZWVUYWIuZmlsZXMuZ2V0UGF0aEZyb21TZWxlY3Rpb24oZGF0YS5zZWxlY3RlZCk7XHJcbiAgICAgICAgICAgIGxldCBzZWxlY3RlZCA9IGF3YWl0IFRyZWVUYWIuZmlsZXMucmVhZEZpbGUoY3VyUGF0aCk7XHJcbiAgICAgICAgICAgIHByZXZEYXRhID0gSlNPTi5wYXJzZShzZWxlY3RlZCk7XHJcbiAgICAgICAgICAgIEVkaXRvclRhYi5mZWVkRGF0YShwcmV2RGF0YSk7XHJcbiAgICAgICAgICAgIGV2ZW50TG9ja2VkID0gZmFsc2U7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0iXX0=