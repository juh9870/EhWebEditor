"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ZipFiles = void 0;
const files_1 = require("./files");
const download = require("downloadjs");
const zip = require("../lib/zip-fs-full.min");
class ZipFiles extends files_1.Files {
    constructor(database) {
        super();
        this.hide = new Set();
        this.database = database;
    }
    static isZipDirectoryEntry(object) {
        return object && 'getChildByName' in object;
    }
    static isZipFileEntry(object) {
        return object && 'getText' in object;
    }
    async init(files) {
        this.fs = new zip.fs.FS();
        let unName = "__UNCHANGED#" + (Math.random() * 0xFFFFFFFFFFFFF).toString(16);
        await Promise.all(files.map(async (file) => {
            if (!file.webkitRelativePath)
                return;
            if (!file.webkitRelativePath.toLowerCase().endsWith(".json"))
                return;
            let text = await file.text();
            if (!await this.database.tryAddFile(file.webkitRelativePath, text))
                return;
            await this.writeFile(unName + "/" + file.webkitRelativePath, text);
        }));
        this.unchangedDir = this.getDirByPath(unName);
        window.fs = this.fs;
        this.hide.add(this.unchangedDir.id);
    }
    async readFile(path) {
        let data = await this.getFileByPath(path);
        if (data == null)
            throw new Error("File not found: " + path);
        return data.getText();
    }
    async writeFile(path, data) {
        let _p = path.split(/[/\\]/);
        while (_p[0].length === 0)
            _p.shift();
        let filename = _p.pop();
        let dir = this.getDirByPath(_p);
        let c = dir.getChildByName(filename);
        if (ZipFiles.isZipFileEntry(c)) {
            c.replaceText(data);
        }
        else {
            c = dir.addText(filename, data);
        }
        if (this.unchangedDir && _p[0] == this.unchangedDir.name) {
            _p[0] = "";
            this.hide.add((await this.writeFile(_p.join("/") + "/" + filename, data)).id);
        }
        return c;
    }
    async treeData() {
        let files = [];
        for (let child of this.fs.entries) {
            if (this.hide.has(child.id))
                continue;
            if (!child.parent)
                continue;
            let el = ZipFiles.isZipFileEntry(child);
            files.push({
                id: child.id,
                parent: child.parent.name !== this.unchangedDir.name ? child.parent.id : "#",
                text: child.name,
                state: {
                    opened: !child.parent
                },
                type: ZipFiles.isZipFileEntry(child) ? "json" : undefined
            });
        }
        return files;
    }
    async getPathFromSelection(selection) {
        return this.entryToPath(this.fs.getById(Number(selection))).join("/");
    }
    async save() {
        let dir = this.fs.children[1];
        if (!ZipFiles.isZipDirectoryEntry(dir)) {
            alert("No changes to save");
            return;
        }
        let blob = await dir.exportBlob();
        await download(blob, dir.name + ".zip", "application/zip");
    }
    async allFiles() {
        let ret = [];
        for (let entry of this.fs.entries) {
            if (this.hide.has(entry.id))
                continue;
            if (!ZipFiles.isZipFileEntry(entry))
                continue;
            let path = (await this.getPathFromSelection(entry.id.toString()));
            ret.push({ path: path, value: await entry.getText() });
        }
        return ret;
    }
    getDirByPath(path) {
        if (typeof path === "string")
            path = path.split(/[/\\]/);
        let cur = this.fs.root;
        for (let i = 0; i < path.length; i++) {
            if (!path[i] || path[i].length === 0)
                continue;
            let c = cur.getChildByName(path[i]);
            if (ZipFiles.isZipDirectoryEntry(c)) {
                cur = c;
            }
            else {
                cur = cur.addDirectory(path[i]);
            }
        }
        return cur;
    }
    entryToPath(node) {
        let arr = [];
        if (node.parent) {
            arr = this.entryToPath(node.parent);
        }
        arr.push(node.name);
        return arr;
    }
    getFileByPath(path) {
        if (typeof path === "string")
            path = path.split(/[/\\]/);
        path = [...path];
        let filename = path.pop();
        let dir = this.getDirByPath(path);
        let c = dir.getChildByName(filename);
        if (ZipFiles.isZipFileEntry(c))
            return c;
        return null;
    }
}
exports.ZipFiles = ZipFiles;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiemlwRmlsZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ6aXBGaWxlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBOEI7QUFFOUIsdUNBQXVDO0FBSXZDLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0FBTzlDLE1BQWEsUUFBUyxTQUFRLGFBQUs7SUFPL0IsWUFBWSxRQUFrQjtRQUMxQixLQUFLLEVBQUUsQ0FBQztRQU5KLFNBQUksR0FBZ0IsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQU8xQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUM3QixDQUFDO0lBRU8sTUFBTSxDQUFDLG1CQUFtQixDQUFDLE1BQWdCO1FBQy9DLE9BQU8sTUFBTSxJQUFJLGdCQUFnQixJQUFJLE1BQU0sQ0FBQztJQUNoRCxDQUFDO0lBRU8sTUFBTSxDQUFDLGNBQWMsQ0FBQyxNQUFnQjtRQUMxQyxPQUFPLE1BQU0sSUFBSSxTQUFTLElBQUksTUFBTSxDQUFDO0lBQ3pDLENBQUM7SUFFRCxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQWE7UUFDcEIsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDMUIsSUFBSSxNQUFNLEdBQUcsY0FBYyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLGVBQWUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM3RSxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLEVBQUU7WUFDckMsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0I7Z0JBQUUsT0FBTztZQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7Z0JBQUUsT0FBTztZQUNyRSxJ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YUFDWDtpQkFBTTtnQkFDSCxHQUFHLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNuQztTQUNKO1FBQ0QsT0FBTyxHQUFHLENBQUM7SUFDZixDQUFDO0lBRU8sV0FBVyxDQUFDLElBQWM7UUFDOUIsSUFBSSxHQUFHLEdBQWEsRUFBRSxDQUFDO1FBQ3ZCLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNiLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN2QztRQUNELEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BCLE9BQU8sR0FBRyxDQUFDO0lBQ2YsQ0FBQztJQUVPLGFBQWEsQ0FBQyxJQUF1QjtRQUN6QyxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVE7WUFBRSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN6RCxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ2pCLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQVksQ0FBQztRQUNwQyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDckMsSUFBSSxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztZQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSjtBQTNJRCw0QkEySUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0ZpbGVzfSBmcm9tIFwiLi9maWxlc1wiO1xyXG5pbXBvcnQge0ZTLCBaaXBEaXJlY3RvcnlFbnRyeSwgWmlwRW50cnksIFppcEZpbGVFbnRyeX0gZnJvbSBcIkB6aXAuanMvemlwLmpzXCI7XHJcbmltcG9ydCAqIGFzIGRvd25sb2FkIGZyb20gXCJkb3dubG9hZGpzXCI7XHJcbmltcG9ydCB7RmlsZUVudHJ5fSBmcm9tIFwiLi90eXBlc1wiO1xyXG5pbXBvcnQge0RhdGFiYXNlfSBmcm9tIFwiLi9kYXRhYmFzZVwiO1xyXG5cclxuY29uc3QgemlwID0gcmVxdWlyZShcIi4uL2xpYi96aXAtZnMtZnVsbC5taW5cIik7XHJcbmRlY2xhcmUgZ2xvYmFsIHtcclxuICAgIGludGVyZmFjZSBGaWxlIHtcclxuICAgICAgICByZWFkb25seSB3ZWJraXRSZWxhdGl2ZVBhdGg6IHN0cmluZztcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFppcEZpbGVzIGV4dGVuZHMgRmlsZXMge1xyXG4gICAgcHJpdmF0ZSBmcyE6IEZTICYgeyBlbnRyaWVzOiBaaXBFbnRyeVtdIH07XHJcbiAgICBwcml2YXRlIGhpZGU6IFNldDxudW1iZXI+ID0gbmV3IFNldDxudW1iZXI+KCk7XHJcbiAgICBwcml2YXRlIHVuY2hhbmdlZERpciE6IFppcERpcmVjdG9yeUVudHJ5O1xyXG4gICAgcHJpdmF0ZSBkYXRhYmFzZTogRGF0YWJhc2U7XHJcblxyXG5cclxuICAgIGNvbnN0cnVjdG9yKGRhdGFiYXNlOiBEYXRhYmFzZSkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5kYXRhYmFzZSA9IGRhdGFiYXNlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIGlzWmlwRGlyZWN0b3J5RW50cnkob2JqZWN0OiBaaXBFbnRyeSk6IG9iamVjdCBpcyBaaXBEaXJlY3RvcnlFbnRyeSB7XHJcbiAgICAgICAgcmV0dXJuIG9iamVjdCAmJiAnZ2V0Q2hpbGRCeU5hbWUnIGluIG9iamVjdDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBpc1ppcEZpbGVFbnRyeShvYmplY3Q6IFppcEVudHJ5KTogb2JqZWN0IGlzIFppcEZpbGVFbnRyeSB7XHJcbiAgICAgICAgcmV0dXJuIG9iamVjdCAmJiAnZ2V0VGV4dCcgaW4gb2JqZWN0O1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGluaXQoZmlsZXM6IEZpbGVbXSkge1xyXG4gICAgICAgIHRoaXMuZnMgPSBuZXcgemlwLmZzLkZTKCk7XHJcbiAgICAgICAgbGV0IHVuTmFtZSA9IFwiX19VTkNIQU5HRUQjXCIgKyAoTWF0aC5yYW5kb20oKSAqIDB4RkZGRkZGRkZGRkZGRikudG9TdHJpbmcoMTYpO1xyXG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKGZpbGVzLm1hcChhc3luYyBmaWxlID0+IHtcclxuICAgICAgICAgICAgaWYgKCFmaWxlLndlYmtpdFJlbGF0aXZlUGF0aCkgcmV0dXJuO1xyXG4gICAgICAgICAgICBpZiAoIWZpbGUud2Via2l0UmVsYXRpdmVQYXRoLnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoXCIuanNvblwiKSkgcmV0dXJuO1xyXG4gICAgICAgICAgICBsZXQgdGV4dCA9IGF3YWl0IGZpbGUudGV4dCgpO1xyXG4gICAgICAgICAgICBpZiAoIWF3YWl0IHRoaXMuZGF0YWJhc2UudHJ5QWRkRmlsZShmaWxlLndlYmtpdFJlbGF0aXZlUGF0aCwgdGV4dCkpIHJldHVybjtcclxuICAgICAgICAgICAgYXdhaXQgdGhpcy53cml0ZUZpbGUodW5OYW1lICsgXCIvXCIgKyBmaWxlLndlYmtpdFJlbGF0aXZlUGF0aCwgdGV4dCk7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICB0aGlzLnVuY2hhbmdlZERpciA9IHRoaXMuZ2V0RGlyQnlQYXRoKHVuTmFtZSk7XHJcblxyXG4gICAgICAgICh3aW5kb3cgYXMgYW55KS5mcyA9IHRoaXMuZnNcclxuICAgICAgICB0aGlzLmhpZGUuYWRkKHRoaXMudW5jaGFuZ2VkRGlyLmlkKTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyByZWFkRmlsZShwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgICAgIGxldCBkYXRhID0gYXdhaXQgdGhpcy5nZXRGaWxlQnlQYXRoKHBhdGgpO1xyXG4gICAgICAgIGlmIChkYXRhID09IG51bGwpIHRocm93IG5ldyBFcnJvcihcIkZpbGUgbm90IGZvdW5kOiBcIiArIHBhdGgpO1xyXG4gICAgICAgIHJldHVybiBkYXRhLmdldFRleHQoKTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyB3cml0ZUZpbGUocGF0aDogc3RyaW5nLCBkYXRhOiBzdHJpbmcpOiBQcm9taXNlPFppcEVudHJ5PiB7XHJcbiAgICAgICAgbGV0IF9wID0gcGF0aC5zcGxpdCgvWy9cXFxcXS8pO1xyXG4gICAgICAgIHdoaWxlIChfcFswXS5sZW5ndGggPT09IDApIF9wLnNoaWZ0KCk7XHJcbiAgICAgICAgbGV0IGZpbGVuYW1lID0gX3AucG9wKCkgYXMgc3RyaW5nO1xyXG4gICAgICAgIGxldCBkaXIgPSB0aGlzLmdldERpckJ5UGF0aChfcCk7XHJcbiAgICAgICAgbGV0IGMgPSBkaXIuZ2V0Q2hpbGRCeU5hbWUoZmlsZW5hbWUpO1xyXG4gICAgICAgIGlmIChaaXBGaWxlcy5pc1ppcEZpbGVFbnRyeShjKSkge1xyXG4gICAgICAgICAgICBjLnJlcGxhY2VUZXh0KGRhdGEpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGMgPSBkaXIuYWRkVGV4dChmaWxlbmFtZSwgZGF0YSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy51bmNoYW5nZWREaXIgJiYgX3BbMF0gPT0gdGhpcy51bmNoYW5nZWREaXIubmFtZSkge1xyXG4gICAgICAgICAgICBfcFswXSA9IFwiXCI7XHJcbiAgICAgICAgICAgIHRoaXMuaGlkZS5hZGQoKGF3YWl0IHRoaXMud3JpdGVGaWxlKF9wLmpvaW4oXCIvXCIpICsgXCIvXCIgKyBmaWxlbmFtZSwgZGF0YSkpLmlkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGM7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgdHJlZURhdGEoKTogUHJvbWlzZTxvYmplY3Q+IHtcclxuICAgICAgICBsZXQgZmlsZXMgPSBbXTtcclxuICAgICAgICBmb3IgKGxldCBjaGlsZCBvZiB0aGlzLmZzLmVudHJpZXMpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaGlkZS5oYXMoY2hpbGQuaWQpKSBjb250aW51ZTtcclxuICAgICAgICAgICAgaWYgKCFjaGlsZC5wYXJlbnQpIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICBsZXQgZWwgPSBaaXBGaWxlcy5pc1ppcEZpbGVFbnRyeShjaGlsZCk7XHJcbiAgICAgICAgICAgIGZpbGVzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgaWQ6IGNoaWxkLmlkLFxyXG4gICAgICAgICAgICAgICAgcGFyZW50OiBjaGlsZC5wYXJlbnQubmFtZSAhPT0gdGhpcy51bmNoYW5nZWREaXIubmFtZSA/IGNoaWxkLnBhcmVudC5pZCA6IFwiI1wiLFxyXG4gICAgICAgICAgICAgICAgdGV4dDogY2hpbGQubmFtZSxcclxuICAgICAgICAgICAgICAgIHN0YXRlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgb3BlbmVkOiAhY2hpbGQucGFyZW50XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgdHlwZTogWmlwRmlsZXMuaXNaaXBGaWxlRW50cnkoY2hpbGQpID8gXCJqc29uXCIgOiB1bmRlZmluZWRcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmaWxlcztcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBnZXRQYXRoRnJvbVNlbGVjdGlvbihzZWxlY3Rpb246IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZW50cnlUb1BhdGgodGhpcy5mcy5nZXRCeUlkKE51bWJlcihzZWxlY3Rpb24pKSkuam9pbihcIi9cIik7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgc2F2ZSgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBsZXQgZGlyID0gdGhpcy5mcy5jaGlsZHJlblsxXTtcclxuICAgICAgICBpZiAoIVppcEZpbGVzLmlzWmlwRGlyZWN0b3J5RW50cnkoZGlyKSkge1xyXG4gICAgICAgICAgICBhbGVydChcIk5vIGNoYW5nZXMgdG8gc2F2ZVwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgYmxvYiA9IGF3YWl0IGRpci5leHBvcnRCbG9iKCk7XHJcbiAgICAgICAgYXdhaXQgZG93bmxvYWQoYmxvYiwgZGlyLm5hbWUgKyBcIi56aXBcIiwgXCJhcHBsaWNhdGlvbi96aXBcIik7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgYWxsRmlsZXMoKTogUHJvbWlzZTxGaWxlRW50cnlbXT4ge1xyXG4gICAgICAgIGxldCByZXQ6IEZpbGVFbnRyeVtdID0gW107XHJcbiAgICAgICAgZm9yIChsZXQgZW50cnkgb2YgdGhpcy5mcy5lbnRyaWVzKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmhpZGUuaGFzKGVudHJ5LmlkKSkgY29udGludWU7XHJcbiAgICAgICAgICAgIGlmICghWmlwRmlsZXMuaXNaaXBGaWxlRW50cnkoZW50cnkpKSBjb250aW51ZTtcclxuICAgICAgICAgICAgbGV0IHBhdGggPSAoYXdhaXQgdGhpcy5nZXRQYXRoRnJvbVNlbGVjdGlvbihlbnRyeS5pZC50b1N0cmluZygpKSk7XHJcbiAgICAgICAgICAgIHJldC5wdXNoKHtwYXRoOiBwYXRoLCB2YWx1ZTogYXdhaXQgZW50cnkuZ2V0VGV4dCgpfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXREaXJCeVBhdGgocGF0aDogc3RyaW5nIHwgc3RyaW5nW10pOiBaaXBEaXJlY3RvcnlFbnRyeSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBwYXRoID09PSBcInN0cmluZ1wiKSBwYXRoID0gcGF0aC5zcGxpdCgvWy9cXFxcXS8pO1xyXG4gICAgICAgIGxldCBjdXI6IFppcERpcmVjdG9yeUVudHJ5ID0gdGhpcy5mcy5yb290O1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGF0aC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAoIXBhdGhbaV0gfHwgcGF0aFtpXS5sZW5ndGggPT09IDApIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICBsZXQgYyA9IGN1ci5nZXRDaGlsZEJ5TmFtZShwYXRoW2ldKTtcclxuICAgICAgICAgICAgaWYgKFppcEZpbGVzLmlzWmlwRGlyZWN0b3J5RW50cnkoYykpIHtcclxuICAgICAgICAgICAgICAgIGN1ciA9IGM7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjdXIgPSBjdXIuYWRkRGlyZWN0b3J5KHBhdGhbaV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBjdXI7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBlbnRyeVRvUGF0aChub2RlOiBaaXBFbnRyeSk6IHN0cmluZ1tdIHtcclxuICAgICAgICBsZXQgYXJyOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgICAgIGlmIChub2RlLnBhcmVudCkge1xyXG4gICAgICAgICAgICBhcnIgPSB0aGlzLmVudHJ5VG9QYXRoKG5vZGUucGFyZW50KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXJyLnB1c2gobm9kZS5uYW1lKTtcclxuICAgICAgICByZXR1cm4gYXJyO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0RmlsZUJ5UGF0aChwYXRoOiBzdHJpbmcgfCBzdHJpbmdbXSk6IFppcEZpbGVFbnRyeSB8IG51bGwge1xyXG4gICAgICAgIGlmICh0eXBlb2YgcGF0aCA9PT0gXCJzdHJpbmdcIikgcGF0aCA9IHBhdGguc3BsaXQoL1svXFxcXF0vKTtcclxuICAgICAgICBwYXRoID0gWy4uLnBhdGhdO1xyXG4gICAgICAgIGxldCBmaWxlbmFtZSA9IHBhdGgucG9wKCkgYXMgc3RyaW5nO1xyXG4gICAgICAgIGxldCBkaXIgPSB0aGlzLmdldERpckJ5UGF0aChwYXRoKTtcclxuICAgICAgICBsZXQgYyA9IGRpci5nZXRDaGlsZEJ5TmFtZShmaWxlbmFtZSk7XHJcbiAgICAgICAgaWYgKFppcEZpbGVzLmlzWmlwRmlsZUVudHJ5KGMpKSByZXR1cm4gYztcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxufSJdfQ==