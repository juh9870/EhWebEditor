"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Database = void 0;
const types_1 = require("./types");
const utils_1 = require("./utils");
const typeMappings_1 = require("./schema/typeMappings");
let mapps = typeMappings_1.TypeMappings.getMappings();
class Database {
    constructor() {
        this.mappings = {};
        for (let type of utils_1.values(types_1.ItemTypesMap)) {
            this.mappings[type] = {};
        }
        this.errors = [];
    }
    static changeIdRecursive(targ, type, oldId, newId) {
        let changed = false;
        for (let key of utils_1.keys(targ)) {
            let val = targ[key];
            if (val && (typeof val === "object" || Array.isArray(val))) {
                changed = changed || Database.changeIdRecursive(val, type, oldId, newId);
            }
            if (Array.isArray(val) && val.length > 0 && typeof val[0] === "number") {
                let _type = typeMappings_1.TypeMappings.fieldType(this, key.toString());
                if (_type !== type)
                    continue;
                // debugger;
                for (let i = 0; i < val.length; i++) {
                    if (val[i] === oldId)
                        val[i] = newId;
                    changed = true;
                }
            }
            else if (typeof val === "number" && val === oldId) {
                let _type = typeMappings_1.TypeMappings.fieldType(targ, key.toString());
                if (_type !== type)
                    continue;
                // debugger;
                targ[key] = newId;
                changed = true;
            }
        }
        return changed;
    }
    async tryAddFile(path, data) {
        var _a, _b, _c;
        try {
            let json = JSON.parse(data);
            if (!json.ItemType)
                return false;
            let old = this.mappings[json.ItemType][(_a = json.Id) !== null && _a !== void 0 ? _a : 0];
            if (old) {
                this.errors.push(`${path} have same ID as ${old.path}`);
                return true;
            }
            this.mappings[json.ItemType][(_b = json.Id) !== null && _b !== void 0 ? _b : 0] = {
                ItemType: json.ItemType,
                Id: (_c = json.Id) !== null && _c !== void 0 ? _c : 0,
                path: path,
                value: data
            };
            return true;
        }
        catch (e) {
            return false;
        }
    }
    async tryApplyChanges(old, changed, files) {
        var _a, _b;
        old.Id = (_a = old.Id) !== null && _a !== void 0 ? _a : 0;
        changed.Id = (_b = changed.Id) !== null && _b !== void 0 ? _b : 0;
        if (old.Id != changed.Id) {
            if (changed.Id > 2 ** 31 - 1) {
                this.err(`Id ${changed.Id} is too large, it must be ${2 ** 31 - 1} at most!`);
                changed.Id = old.Id;
            }
            else {
                let targ = this.mappings[changed.ItemType][changed.Id];
                if (targ) {
                    this.err(`Id ${types_1.ItemTypesMapRev[changed.ItemType]}.${changed.Id} is already occupied by ${targ.path}`);
                    changed.Id = old.Id;
                }
                else {
                    this.mappings[changed.ItemType][changed.Id] = this.mappings[changed.ItemType][old.Id];
                    delete this.mappings[changed.ItemType][old.Id];
                    await this.changeIds(files, changed.ItemType, old.Id, changed.Id);
                }
            }
        }
        return true;
    }
    async changeIds(files, type, oldId, newId) {
        for (let file of (await files.allFiles())) {
            let data = JSON.parse(file.value);
            if (Database.changeIdRecursive(data, type, oldId, newId)) {
                await files.writeFile(file.path, JSON.stringify(data, undefined, "\t"));
            }
        }
    }
    getIds(type) {
        return utils_1.keys(this.mappings[type]).map(e => Number(e));
    }
    err(message) {
        console.warn(message);
        alert(message);
    }
}
exports.Database = Database;
Database.deleteNumber = 2 ** 32 - 9870;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkYXRhYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBb0c7QUFDcEcsbUNBQXFDO0FBQ3JDLHdEQUFtRDtBQUtuRCxJQUFJLEtBQUssR0FBRywyQkFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBRXZDLE1BQWEsUUFBUTtJQUtqQjtRQUhPLGFBQVEsR0FBNEMsRUFBRSxDQUFDO1FBSTFELEtBQUssSUFBSSxJQUFJLElBQUksY0FBTSxDQUFDLG9CQUFZLENBQUMsRUFBRTtZQUNuQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztTQUM1QjtRQUNELElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFTyxNQUFNLENBQUMsaUJBQWlCLENBQUMsSUFBUyxFQUFFLElBQWMsRUFBRSxLQUFhLEVBQUUsS0FBYTtRQUNwRixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDcEIsS0FBSyxJQUFJLEdBQUcsSUFBSSxZQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDeEIsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3BCLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssUUFBUSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtnQkFDeEQsT0FBTyxHQUFHLE9BQU8sSUFBSSxRQUFRLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDNUU7WUFDRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssUUFBUSxFQUFFO2dCQUNwRSxJQUFJLEtB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Q0FBQyxFQUFFO2dCQUN0RCxNQUFNLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQzthQUMzRTtTQUNKO0lBQ0wsQ0FBQztJQUVNLE1BQU0sQ0FBQyxJQUFjO1FBQ3hCLE9BQU8sWUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRU8sR0FBRyxDQUFDLE9BQWU7UUFDdkIsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0QixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbkIsQ0FBQzs7QUFuR0wsNEJBb0dDO0FBbkdpQixxQkFBWSxHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtEYXRhYmFzZUZpbGUsIEZpbGVFbnRyeSwgSXRlbVR5cGUsIEl0ZW1UeXBlc01hcCwgSXRlbVR5cGVzTWFwUmV2LCBOdW1iZXJNYXB9IGZyb20gXCIuL3R5cGVzXCI7XHJcbmltcG9ydCB7a2V5cywgdmFsdWVzfSBmcm9tIFwiLi91dGlsc1wiO1xyXG5pbXBvcnQge1R5cGVNYXBwaW5nc30gZnJvbSBcIi4vc2NoZW1hL3R5cGVNYXBwaW5nc1wiO1xyXG5pbXBvcnQge0ZpbGVzfSBmcm9tIFwiLi9maWxlc1wiO1xyXG5cclxuZXhwb3J0IHR5cGUgRGF0YWJhc2VGaWxlRW50cnkgPSBGaWxlRW50cnkgJiBEYXRhYmFzZUZpbGVcclxuXHJcbmxldCBtYXBwcyA9IFR5cGVNYXBwaW5ncy5nZXRNYXBwaW5ncygpO1xyXG5cclxuZXhwb3J0IGNsYXNzIERhdGFiYXNlIHtcclxuICAgIHB1YmxpYyBzdGF0aWMgZGVsZXRlTnVtYmVyID0gMiAqKiAzMiAtIDk4NzA7XHJcbiAgICBwdWJsaWMgbWFwcGluZ3M6IE51bWJlck1hcDxOdW1iZXJNYXA8RGF0YWJhc2VGaWxlRW50cnk+PiA9IHt9O1xyXG4gICAgcHVibGljIGVycm9yczogc3RyaW5nW107XHJcblxyXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIGZvciAobGV0IHR5cGUgb2YgdmFsdWVzKEl0ZW1UeXBlc01hcCkpIHtcclxuICAgICAgICAgICAgdGhpcy5tYXBwaW5nc1t0eXBlXSA9IHt9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmVycm9ycyA9IFtdO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIGNoYW5nZUlkUmVjdXJzaXZlKHRhcmc6IGFueSwgdHlwZTogSXRlbVR5cGUsIG9sZElkOiBudW1iZXIsIG5ld0lkOiBudW1iZXIpOiBib29sZWFuIHtcclxuICAgICAgICBsZXQgY2hhbmdlZCA9IGZhbHNlO1xyXG4gICAgICAgIGZvciAobGV0IGtleSBvZiBrZXlzKHRhcmcpKSB7XHJcbiAgICAgICAgICAgIGxldCB2YWwgPSB0YXJnW2tleV07XHJcbiAgICAgICAgICAgIGlmICh2YWwgJiYgKHR5cGVvZiB2YWwgPT09IFwib2JqZWN0XCIgfHwgQXJyYXkuaXNBcnJheSh2YWwpKSkge1xyXG4gICAgICAgICAgICAgICAgY2hhbmdlZCA9IGNoYW5nZWQgfHwgRGF0YWJhc2UuY2hhbmdlSWRSZWN1cnNpdmUodmFsLCB0eXBlLCBvbGRJZCwgbmV3SWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbCkgJiYgdmFsLmxlbmd0aCA+IDAgJiYgdHlwZW9mIHZhbFswXSA9PT0gXCJudW1iZXJcIikge1xyXG4gICAgICAgICAgICAgICAgbGV0IF90eXBlID0gVHlwZU1hcHBpbmdzLmZpZWxkVHlwZSh0aGlzLCBrZXkudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoX3R5cGUgIT09IHR5cGUpIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgLy8gZGVidWdnZXI7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWxbaV0gPT09IG9sZElkKSB2YWxbaV0gPSBuZXdJZDtcclxuICAgICAgICAgICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSBcIm51bWJlclwiICYmIHZhbCA9PT0gb2xkSWQpIHtcclxuICAgICAgICAgICAgICAgIGxldCBfdHlwZSA9IFR5cGVNYXBwaW5ncy5maWVsZFR5cGUodGFyZywga2V5LnRvU3RyaW5nKCkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKF90eXBlICE9PSB0eXBlKSBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIC8vIGRlYnVnZ2VyO1xyXG4gICAgICAgICAgICAgICAgdGFyZ1trZXldID0gbmV3SWQ7XHJcbiAgICAgICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY2hhbmdlZDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgdHJ5QWRkRmlsZShwYXRoOiBzdHJpbmcsIGRhdGE6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGxldCBqc29uID0gSlNPTi5wYXJzZShkYXRhKTtcclxuICAgICAgICAgICAgaWYgKCFqc29uLkl0ZW1UeXBlKSByZXR1cm4gZmFsc2U7XHJcblxyXG4gICAgICAgICAgICBsZXQgb2xkID0gdGhpcy5tYXBwaW5nc1tqc29uLkl0ZW1UeXBlXVtqc29uLklkID8/IDBdO1xyXG5cclxuICAgICAgICAgICAgaWYgKG9sZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lcnJvcnMucHVzaChgJHtwYXRofSBoYXZlIHNhbWUgSUQgYXMgJHtvbGQucGF0aH1gKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMubWFwcGluZ3NbanNvbi5JdGVtVHlwZV1banNvbi5JZCA/PyAwXSA9IHtcclxuICAgICAgICAgICAgICAgIEl0ZW1UeXBlOiBqc29uLkl0ZW1UeXBlLFxyXG4gICAgICAgICAgICAgICAgSWQ6IGpzb24uSWQgPz8gMCxcclxuICAgICAgICAgICAgICAgIHBhdGg6IHBhdGgsXHJcbiAgICAgICAgICAgICAgICB2YWx1ZTogZGF0YVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgdHJ5QXBwbHlDaGFuZ2VzKG9sZDogRGF0YWJhc2VGaWxlLCBjaGFuZ2VkOiBEYXRhYmFzZUZpbGUsIGZpbGVzOiBGaWxlcyk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIG9sZC5JZCA9IG9sZC5JZCA/PyAwO1xyXG4gICAgICAgIGNoYW5nZWQuSWQgPSBjaGFuZ2VkLklkID8/IDA7XHJcbiAgICAgICAgaWYgKG9sZC5JZCAhPSBjaGFuZ2VkLklkKSB7XHJcbiAgICAgICAgICAgIGlmIChjaGFuZ2VkLklkID4gMiAqKiAzMSAtIDEpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZXJyKGBJZCAke2NoYW5nZWQuSWR9IGlzIHRvbyBsYXJnZSwgaXQgbXVzdCBiZSAkezIqKjMxLTF9IGF0IG1vc3QhYCk7XHJcbiAgICAgICAgICAgICAgICBjaGFuZ2VkLklkID0gb2xkLklkO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGV0IHRhcmcgPSB0aGlzLm1hcHBpbmdzW2NoYW5nZWQuSXRlbVR5cGVdW2NoYW5nZWQuSWRdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRhcmcpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVycihgSWQgJHtJdGVtVHlwZXNNYXBSZXZbY2hhbmdlZC5JdGVtVHlwZV19LiR7Y2hhbmdlZC5JZH0gaXMgYWxyZWFkeSBvY2N1cGllZCBieSAke3RhcmcucGF0aH1gKTtcclxuICAgICAgICAgICAgICAgICAgICBjaGFuZ2VkLklkID0gb2xkLklkO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcHBpbmdzW2NoYW5nZWQuSXRlbVR5cGVdW2NoYW5nZWQuSWRdID0gdGhpcy5tYXBwaW5nc1tjaGFuZ2VkLkl0ZW1UeXBlXVtvbGQuSWRdO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm1hcHBpbmdzW2NoYW5nZWQuSXRlbVR5cGVdW29sZC5JZF07XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5jaGFuZ2VJZHMoZmlsZXMsIGNoYW5nZWQuSXRlbVR5cGUsIG9sZC5JZCwgY2hhbmdlZC5JZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGNoYW5nZUlkcyhmaWxlczogRmlsZXMsIHR5cGU6IEl0ZW1UeXBlLCBvbGRJZDogbnVtYmVyLCBuZXdJZDogbnVtYmVyKSB7XHJcbiAgICAgICAgZm9yIChsZXQgZmlsZSBvZiAoYXdhaXQgZmlsZXMuYWxsRmlsZXMoKSkpIHtcclxuICAgICAgICAgICAgbGV0IGRhdGEgPSBKU09OLnBhcnNlKGZpbGUudmFsdWUpO1xyXG4gICAgICAgICAgICBpZiAoRGF0YWJhc2UuY2hhbmdlSWRSZWN1cnNpdmUoZGF0YSwgdHlwZSwgb2xkSWQsIG5ld0lkKSkge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgZmlsZXMud3JpdGVGaWxlKGZpbGUucGF0aCwgSlNPTi5zdHJpbmdpZnkoZGF0YSwgdW5kZWZpbmVkLCBcIlxcdFwiKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldElkcyh0eXBlOiBJdGVtVHlwZSk6IG51bWJlcltdIHtcclxuICAgICAgICByZXR1cm4ga2V5cyh0aGlzLm1hcHBpbmdzW3R5cGVdKS5tYXAoZSA9PiBOdW1iZXIoZSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZXJyKG1lc3NhZ2U6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnNvbGUud2FybihtZXNzYWdlKTtcclxuICAgICAgICBhbGVydChtZXNzYWdlKTtcclxuICAgIH1cclxufSJdfQ==