"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TreeTab = void 0;
const $ = require("jquery");
const EditorTab_1 = require("./EditorTab");
const equal = require("deep-equal");
require("jstree");
let treeBase;
let tree;
let curPath = "";
let prevData;
let eventLocked;
let to;
let folderInput;
let saveButton;
let searchInput;
let ready = false;
let cover;
let lockEvents = (text) => {
    cover.find("div")[0].textContent = text;
    if (eventLocked) {
        return;
    }
    eventLocked = true;
    cover.show(0.5);
};
let unlockEvents = () => {
    if (!eventLocked)
        return;
    eventLocked = false;
    cover.hide(0.5);
};
class TreeTab {
    static init(files, database) {
        cover = $(`<div class="cover"><div></div><div class="loader"></div></div>`);
        $("body").append(cover);
        lockEvents("Editor is starting");
        TreeTab.files = files;
        TreeTab.database = database;
        let holder = $("#treeHolder");
        let r1 = $("<div class='r1'></div>");
        let r2 = $("<div class='r2'></div>");
        holder.append(r1);
        holder.append(r2);
        folderInput = $(`<input type="file" webkitdirectory multiple>`);
        saveButton = $(`<input type="button" value="Save database">`);
        let searchLabel = $(`<label for="tree-search">Search: </label>`);
        searchInput = $(`<input id="tree-search" type="search">`);
        r1.append(folderInput);
        r1.append(saveButton);
        r2.append(searchLabel);
        r2.append(searchInput);
        saveButton.prop("disabled", true);
        searchInput.prop("disabled", true);
        treeBase = $(`<div></div>`);
        holder.append(treeBase);
        folderInput.on("change", async (event) => {
            if (eventLocked)
                return;
            lockEvents("Loading database");
            if (ready && prompt("Save before changing database?")) {
                await TreeTab.saveDatabase();
                lockEvents("Loading database");
            }
            await TreeTab.close();
            let _files = Array.from(folderInput[0].files);
            await TreeTab.files.init(_files);
            await TreeTab.redrawTree();
            ready = true;
            unlockEvents();
        });
        saveButton.on('click', async () => {
            if (eventLocked)
                return;
            lockEvents("Saving database (this might take some time on larger database)");
            await TreeTab.saveDatabase();
            unlockEvents();
        });
        searchInput.on('keyup', () => {
            if (!tree)
                return;
            if (to)
                clearTimeout(to);
            to = setTimeout(function () {
                let v = searchInput.val();
                tree.search(v);
            }, 250);
        });
        unlockEvents();
    }
    static async saveDatabase() {
        lockEvents("Archiving database (this might take some time on larger database)");
        await TreeTab.close();
        lockEvents("Preparing download (if this step takes too long, something might b wrong with your device)");
        await TreeTab.files.save();
    }
    static async redrawTree() {
        if (tree)
            tree.destroy(false);
        saveButton.prop("disabled", true);
        searchInput.prop("disabled", true);
        tree = treeBase.jstree({
            core: {
                data: await TreeTab.files.treeData(),
                error: console.error,
                multiple: false,
            },
            types: {
                json: {
                    icon: "assets/json.png",
                    max_children: 0
                }
            },
            search: {
                show_only_matches: true,
                show_only_matches_children: true
            },
            plugins: ["search", "types", "wholerow"]
        }).jstree(true);
        TreeTab.createEvents();
        saveButton.prop("disabled", false);
        searchInput.prop("disabled", false);
    }
    static async save() {
        try {
            if (!curPath.length)
                return;
            let curData = await EditorTab_1.EditorTab.getData();
            if (!equal(curData, prevData, { strict: true })) {
                if (!await TreeTab.database.tryApplyChanges(prevData, curData, this.files)) {
                    return;
                }
                let curDataStr = JSON.stringify(curData, null, "\t");
                await TreeTab.files.writeFile(curPath, curDataStr);
            }
        }
        catch (e) {
            return;
        }
    }
    static async close() {
        await TreeTab.save();
        EditorTab_1.EditorTab.closeAll();
    }
    static createEvents() {
        treeBase.on('changed.jstree', async function (e, data) {
            var _a;
            if (eventLocked)
                return;
            if (((_a = data === null || data === void 0 ? void 0 : data.node) === null || _a === void 0 ? void 0 : _a.type) !== "json")
                return;
            lockEvents("Saving current file.");
            await TreeTab.save();
            curPath = await TreeTab.files.getPathFromSelection(data.selected);
            let selected = await TreeTab.files.readFile(curPath);
            prevData = JSON.parse(selected);
            lockEvents("Opening new file.");
            EditorTab_1.EditorTab.feedData(prevData);
            unlockEvents();
        });
    }
}
exports.TreeTab = TreeTab;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHJlZVRhYi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlRyZWVUYWIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNEJBQTRCO0FBRTVCLDJDQUFzQztBQUd0QyxvQ0FBcUM7QUFFckMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRWxCLElBQUksUUFBZ0IsQ0FBQTtBQUNwQixJQUFJLElBQVksQ0FBQztBQUNqQixJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFDakIsSUFBSSxRQUFzQixDQUFDO0FBQzNCLElBQUksV0FBb0IsQ0FBQztBQUN6QixJQUFJLEVBQU8sQ0FBQztBQUNaLElBQUksV0FBcUMsQ0FBQztBQUMxQyxJQUFJLFVBQW9DLENBQUM7QUFDekMsSUFBSSxXQUFxQyxDQUFDO0FBQzFDLElBQUksS0FBSyxHQUFHLEtBQUssQ0FBQztBQUNsQixJQUFJLEtBQTBCLENBQUM7QUFFL0IsSUFBSSxVQUFVLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBRTtJQUM5QixLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsR0FBQyxJQUFJLENBQUM7SUFDdEMsSUFBSSxXQUFXLEVBQUU7UUFDYixPQUFPO0tBQ1Y7SUFDRCxXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQ25CLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDcEIsQ0FBQyxDQUFBO0FBRUQsSUFBSSxZQUFZLEdBQUcsR0FBRyxFQUFFO0lBQ3BCLElBQUksQ0FBQyxXQUFXO1FBQUUsT0FBTztJQUN6QixXQUFXLEdBQUcsS0FBSyxDQUFDO0lBQ3BCLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDcEIsQ0FBQyxDQUFBO0FBRUQsTUFBYSxPQUFPO0lBSVQsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFZLEVBQUUsUUFBa0I7UUFDL0MsS0FBSyxHQUFHLENBQUMsQ0FBQyxnRUFBZ0UsQ0FBQyxD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Q2pELElBQUksV0FBVztnQkFBRSxPQUFPO1lBQ3hCLElBQUksQ0FBQSxNQUFBLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxJQUFJLDBDQUFFLElBQUksTUFBSyxNQUFNO2dCQUFFLE9BQU87WUFDeEMsVUFBVSxDQUFDLHNCQUFzQixDQUFDLENBQUM7WUFDbkMsTUFBTSxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDckIsT0FBTyxHQUFHLE1BQU0sT0FBTyxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbEUsSUFBSSxRQUFRLEdBQUcsTUFBTSxPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNyRCxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNoQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUNoQyxxQkFBUyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM3QixZQUFZLEVBQUUsQ0FBQztRQUNuQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQWpJRCwwQkFpSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyAkIGZyb20gXCJqcXVlcnlcIjtcclxuaW1wb3J0IHtGaWxlc30gZnJvbSBcIi4uL2ZpbGVzXCI7XHJcbmltcG9ydCB7RWRpdG9yVGFifSBmcm9tIFwiLi9FZGl0b3JUYWJcIjtcclxuaW1wb3J0IHtEYXRhYmFzZUZpbGV9IGZyb20gXCIuLi90eXBlc1wiO1xyXG5pbXBvcnQge0RhdGFiYXNlfSBmcm9tIFwiLi4vZGF0YWJhc2VcIjtcclxuaW1wb3J0IGVxdWFsID0gcmVxdWlyZShcImRlZXAtZXF1YWxcIik7XHJcblxyXG5yZXF1aXJlKFwianN0cmVlXCIpO1xyXG5cclxubGV0IHRyZWVCYXNlOiBKUXVlcnlcclxubGV0IHRyZWU6IEpTVHJlZTtcclxubGV0IGN1clBhdGggPSBcIlwiO1xyXG5sZXQgcHJldkRhdGE6IERhdGFiYXNlRmlsZTtcclxubGV0IGV2ZW50TG9ja2VkOiBib29sZWFuO1xyXG5sZXQgdG86IGFueTtcclxubGV0IGZvbGRlcklucHV0OiBKUXVlcnk8SFRNTElucHV0RWxlbWVudD47XHJcbmxldCBzYXZlQnV0dG9uOiBKUXVlcnk8SFRNTElucHV0RWxlbWVudD47XHJcbmxldCBzZWFyY2hJbnB1dDogSlF1ZXJ5PEhUTUxJbnB1dEVsZW1lbnQ+O1xyXG5sZXQgcmVhZHkgPSBmYWxzZTtcclxubGV0IGNvdmVyOiBKUXVlcnk8SFRNTEVsZW1lbnQ+O1xyXG5cclxubGV0IGxvY2tFdmVudHMgPSAodGV4dDogc3RyaW5nKSA9PiB7XHJcbiAgICBjb3Zlci5maW5kKFwiZGl2XCIpWzBdLnRleHRDb250ZW50PXRleHQ7XHJcbiAgICBpZiAoZXZlbnRMb2NrZWQpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBldmVudExvY2tlZCA9IHRydWU7XHJcbiAgICBjb3Zlci5zaG93KDAuNSk7XHJcbn1cclxuXHJcbmxldCB1bmxvY2tFdmVudHMgPSAoKSA9PiB7XHJcbiAgICBpZiAoIWV2ZW50TG9ja2VkKSByZXR1cm47XHJcbiAgICBldmVudExvY2tlZCA9IGZhbHNlO1xyXG4gICAgY292ZXIuaGlkZSgwLjUpO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgVHJlZVRhYiB7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBmaWxlczogRmlsZXM7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBkYXRhYmFzZTogRGF0YWJhc2U7XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBpbml0KGZpbGVzOiBGaWxlcywgZGF0YWJhc2U6IERhdGFiYXNlKSB7XHJcbiAgICAgICAgY292ZXIgPSAkKGA8ZGl2IGNsYXNzPVwiY292ZXJcIj48ZGl2PjwvZGl2PjxkaXYgY2xhc3M9XCJsb2FkZXJcIj48L2Rpdj48L2Rpdj5gKTtcclxuICAgICAgICAkKFwiYm9keVwiKS5hcHBlbmQoY292ZXIpO1xyXG4gICAgICAgIGxvY2tFdmVudHMoXCJFZGl0b3IgaXMgc3RhcnRpbmdcIik7XHJcbiAgICAgICAgVHJlZVRhYi5maWxlcyA9IGZpbGVzO1xyXG4gICAgICAgIFRyZWVUYWIuZGF0YWJhc2UgPSBkYXRhYmFzZTtcclxuICAgICAgICBsZXQgaG9sZGVyID0gJChcIiN0cmVlSG9sZGVyXCIpO1xyXG4gICAgICAgIGxldCByMSA9ICQoXCI8ZGl2IGNsYXNzPSdyMSc+PC9kaXY+XCIpO1xyXG4gICAgICAgIGxldCByMiA9ICQoXCI8ZGl2IGNsYXNzPSdyMic+PC9kaXY+XCIpO1xyXG4gICAgICAgIGhvbGRlci5hcHBlbmQocjEpO1xyXG4gICAgICAgIGhvbGRlci5hcHBlbmQocjIpO1xyXG4gICAgICAgIGZvbGRlcklucHV0ID0gJChgPGlucHV0IHR5cGU9XCJmaWxlXCIgd2Via2l0ZGlyZWN0b3J5IG11bHRpcGxlPmApO1xyXG4gICAgICAgIHNhdmVCdXR0b24gPSAkKGA8aW5wdXQgdHlwZT1cImJ1dHRvblwiIHZhbHVlPVwiU2F2ZSBkYXRhYmFzZVwiPmApO1xyXG4gICAgICAgIGxldCBzZWFyY2hMYWJlbCA9ICQoYDxsYWJlbCBmb3I9XCJ0cmVlLXNlYXJjaFwiPlNlYXJjaDogPC9sYWJlbD5gKVxyXG4gICAgICAgIHNlYXJjaElucHV0ID0gJChgPGlucHV0IGlkPVwidHJlZS1zZWFyY2hcIiB0eXBlPVwic2VhcmNoXCI+YCk7XHJcbiAgICAgICAgcjEuYXBwZW5kKGZvbGRlcklucHV0KTtcclxuICAgICAgICByMS5hcHBlbmQoc2F2ZUJ1dHRvbik7XHJcbiAgICAgICAgcjIuYXBwZW5kKHNlYXJjaExhYmVsKTtcclxuICAgICAgICByMi5hcHBlbmQoc2VhcmNoSW5wdXQpO1xyXG4gICAgICAgIHNhdmVCdXR0b24ucHJvcChcImRpc2FibGVkXCIsIHRydWUpO1xyXG4gICAgICAgIHNlYXJjaElucHV0LnByb3AoXCJkaXNhYmxlZFwiLCB0cnVlKTtcclxuICAgICAgICB0cmVlQmFzZSA9ICQoYDxkaXY+PC9kaXY+YCk7XHJcbiAgICAgICAgaG9sZGVyLmFwcGVuZCh0cmVlQmFzZSk7XHJcbiAgICAgICAgZm9sZGVySW5wdXQub24oXCJjaGFuZ2VcIiwgYXN5bmMgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChldmVudExvY2tlZCkgcmV0dXJuO1xyXG4gICAgICAgICAgICBsb2NrRXZlbnRzKFwiTG9hZGluZyBkYXRhYmFzZVwiKTtcclxuICAgICAgICAgICAgaWYgKHJlYWR5ICYmIHByb21wdChcIlNhdmUgYmVmb3JlIGNoYW5naW5nIGRhdGFiYXNlP1wiKSkge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgVHJlZVRhYi5zYXZlRGF0YWJhc2UoKTtcclxuICAgICAgICAgICAgICAgIGxvY2tFdmVudHMoXCJMb2FkaW5nIGRhdGFiYXNlXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGF3YWl0IFRyZWVUYWIuY2xvc2UoKTtcclxuICAgICAgICAgICAgbGV0IF9maWxlcyA9IEFycmF5LmZyb20oZm9sZGVySW5wdXRbMF0uZmlsZXMgYXMgRmlsZUxpc3QpO1xyXG4gICAgICAgICAgICBhd2FpdCBUcmVlVGFiLmZpbGVzLmluaXQoX2ZpbGVzKTtcclxuICAgICAgICAgICAgYXdhaXQgVHJlZVRhYi5yZWRyYXdUcmVlKCk7XHJcbiAgICAgICAgICAgIHJlYWR5ID0gdHJ1ZTtcclxuICAgICAgICAgICAgdW5sb2NrRXZlbnRzKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgc2F2ZUJ1dHRvbi5vbignY2xpY2snLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChldmVudExvY2tlZCkgcmV0dXJuO1xyXG4gICAgICAgICAgICBsb2NrRXZlbnRzKFwiU2F2aW5nIGRhdGFiYXNlICh0aGlzIG1pZ2h0IHRha2Ugc29tZSB0aW1lIG9uIGxhcmdlciBkYXRhYmFzZSlcIik7XHJcbiAgICAgICAgICAgIGF3YWl0IFRyZWVUYWIuc2F2ZURhdGFiYXNlKCk7XHJcbiAgICAgICAgICAgIHVubG9ja0V2ZW50cygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNlYXJjaElucHV0Lm9uKCdrZXl1cCcsICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKCF0cmVlKSByZXR1cm47XHJcbiAgICAgICAgICAgIGlmICh0bykgY2xlYXJUaW1lb3V0KHRvKTtcclxuICAgICAgICAgICAgdG8gPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGxldCB2ID0gc2VhcmNoSW5wdXQudmFsKCkgYXMgc3RyaW5nO1xyXG4gICAgICAgICAgICAgICAgdHJlZS5zZWFyY2godik7XHJcbiAgICAgICAgICAgIH0sIDI1MCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdW5sb2NrRXZlbnRzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBzYXZlRGF0YWJhc2UoKSB7XHJcbiAgICAgICAgbG9ja0V2ZW50cyhcIkFyY2hpdmluZyBkYXRhYmFzZSAodGhpcyBtaWdodCB0YWtlIHNvbWUgdGltZSBvbiBsYXJnZXIgZGF0YWJhc2UpXCIpO1xyXG4gICAgICAgIGF3YWl0IFRyZWVUYWIuY2xvc2UoKTtcclxuXHJcbiAgICAgICAgbG9ja0V2ZW50cyhcIlByZXBhcmluZyBkb3dubG9hZCAoaWYgdGhpcyBzdGVwIHRha2VzIHRvbyBsb25nLCBzb21ldGhpbmcgbWlnaHQgYiB3cm9uZyB3aXRoIHlvdXIgZGV2aWNlKVwiKTtcclxuICAgICAgICBhd2FpdCBUcmVlVGFiLmZpbGVzLnNhdmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIHJlZHJhd1RyZWUoKSB7XHJcbiAgICAgICAgaWYgKHRyZWUpIHRyZWUuZGVzdHJveShmYWxzZSk7XHJcbiAgICAgICAgc2F2ZUJ1dHRvbi5wcm9wKFwiZGlzYWJsZWRcIiwgdHJ1ZSk7XHJcbiAgICAgICAgc2VhcmNoSW5wdXQucHJvcChcImRpc2FibGVkXCIsIHRydWUpO1xyXG4gICAgICAgIHRyZWUgPSB0cmVlQmFzZS5qc3RyZWUoe1xyXG4gICAgICAgICAgICBjb3JlOiB7XHJcbiAgICAgICAgICAgICAgICBkYXRhOiBhd2FpdCBUcmVlVGFiLmZpbGVzLnRyZWVEYXRhKCksXHJcbiAgICAgICAgICAgICAgICBlcnJvcjogY29uc29sZS5lcnJvcixcclxuICAgICAgICAgICAgICAgIG11bHRpcGxlOiBmYWxzZSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgdHlwZXM6IHtcclxuICAgICAgICAgICAgICAgIGpzb246IHtcclxuICAgICAgICAgICAgICAgICAgICBpY29uOiBcImFzc2V0cy9qc29uLnBuZ1wiLFxyXG4gICAgICAgICAgICAgICAgICAgIG1heF9jaGlsZHJlbjogMFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzZWFyY2g6IHtcclxuICAgICAgICAgICAgICAgIHNob3dfb25seV9tYXRjaGVzOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgc2hvd19vbmx5X21hdGNoZXNfY2hpbGRyZW46IHRydWVcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcGx1Z2luczogW1wic2VhcmNoXCIsIFwidHlwZXNcIiwgXCJ3aG9sZXJvd1wiXVxyXG4gICAgICAgIH0gYXMgSlNUcmVlU3RhdGljRGVmYXVsdHMpLmpzdHJlZSh0cnVlKTtcclxuICAgICAgICBUcmVlVGFiLmNyZWF0ZUV2ZW50cygpO1xyXG4gICAgICAgIHNhdmVCdXR0b24ucHJvcChcImRpc2FibGVkXCIsIGZhbHNlKTtcclxuICAgICAgICBzZWFyY2hJbnB1dC5wcm9wKFwiZGlzYWJsZWRcIiwgZmFsc2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgc2F2ZSgpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAoIWN1clBhdGgubGVuZ3RoKSByZXR1cm47XHJcbiAgICAgICAgICAgIGxldCBjdXJEYXRhOiBEYXRhYmFzZUZpbGUgPSBhd2FpdCBFZGl0b3JUYWIuZ2V0RGF0YSgpO1xyXG5cclxuICAgICAgICAgICAgaWYgKCFlcXVhbChjdXJEYXRhLCBwcmV2RGF0YSwge3N0cmljdDogdHJ1ZX0pKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWF3YWl0IFRyZWVUYWIuZGF0YWJhc2UudHJ5QXBwbHlDaGFuZ2VzKHByZXZEYXRhLCBjdXJEYXRhLCB0aGlzLmZpbGVzKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGxldCBjdXJEYXRhU3RyID0gSlNPTi5zdHJpbmdpZnkoY3VyRGF0YSxudWxsLFwiXFx0XCIpO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgVHJlZVRhYi5maWxlcy53cml0ZUZpbGUoY3VyUGF0aCwgY3VyRGF0YVN0cik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBjbG9zZSgpIHtcclxuICAgICAgICBhd2FpdCBUcmVlVGFiLnNhdmUoKTtcclxuICAgICAgICBFZGl0b3JUYWIuY2xvc2VBbGwoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGNyZWF0ZUV2ZW50cygpIHtcclxuICAgICAgICB0cmVlQmFzZS5vbignY2hhbmdlZC5qc3RyZWUnLCBhc3luYyBmdW5jdGlvbiAoZSwgZGF0YSkge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnRMb2NrZWQpIHJldHVybjtcclxuICAgICAgICAgICAgaWYgKGRhdGE/Lm5vZGU/LnR5cGUgIT09IFwianNvblwiKSByZXR1cm47XHJcbiAgICAgICAgICAgIGxvY2tFdmVudHMoXCJTYXZpbmcgY3VycmVudCBmaWxlLlwiKTtcclxuICAgICAgICAgICAgYXdhaXQgVHJlZVRhYi5zYXZlKCk7XHJcbiAgICAgICAgICAgIGN1clBhdGggPSBhd2FpdCBUcmVlVGFiLmZpbGVzLmdldFBhdGhGcm9tU2VsZWN0aW9uKGRhdGEuc2VsZWN0ZWQpO1xyXG4gICAgICAgICAgICBsZXQgc2VsZWN0ZWQgPSBhd2FpdCBUcmVlVGFiLmZpbGVzLnJlYWRGaWxlKGN1clBhdGgpO1xyXG4gICAgICAgICAgICBwcmV2RGF0YSA9IEpTT04ucGFyc2Uoc2VsZWN0ZWQpO1xyXG4gICAgICAgICAgICBsb2NrRXZlbnRzKFwiT3BlbmluZyBuZXcgZmlsZS5cIik7XHJcbiAgICAgICAgICAgIEVkaXRvclRhYi5mZWVkRGF0YShwcmV2RGF0YSk7XHJcbiAgICAgICAgICAgIHVubG9ja0V2ZW50cygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59Il19