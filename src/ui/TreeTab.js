"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TreeTab = void 0;
const $ = require("jquery");
const EditorTab_1 = require("./EditorTab");
const equal = require("deep-equal");
require("jstree");
let treeBase;
let tree;
let curPath = "";
let prevData;
let eventLocked;
let to;
let folderInput;
let saveButton;
let searchInput;
let ready = false;
let cover;
let lockEvents = (text) => {
    cover.find("div")[0].textContent = text;
    if (eventLocked) {
        return;
    }
    eventLocked = true;
    cover.show(0.5);
};
let unlockEvents = () => {
    if (!eventLocked)
        return;
    eventLocked = false;
    cover.hide(0.5);
};
class TreeTab {
    static init(files, database) {
        cover = $(`<div class="cover"><div></div><div class="loader"></div></div>`);
        $("body").append(cover);
        lockEvents("Editor is starting");
        TreeTab.files = files;
        TreeTab.database = database;
        let holder = $("#treeHolder");
        let r1 = $("<div class='r1'></div>");
        let r2 = $("<div class='r2'></div>");
        holder.append(r1);
        holder.append(r2);
        folderInput = $(`<input type="file" webkitdirectory multiple>`);
        saveButton = $(`<input type="button" value="Save database">`);
        let searchLabel = $(`<label for="tree-search">Search: </label>`);
        searchInput = $(`<input id="tree-search" type="search">`);
        r1.append(folderInput);
        r1.append(saveButton);
        r2.append(searchLabel);
        r2.append(searchInput);
        saveButton.prop("disabled", true);
        searchInput.prop("disabled", true);
        treeBase = $(`<div></div>`);
        holder.append(treeBase);
        folderInput.on("change", async (event) => {
            if (eventLocked)
                return;
            lockEvents("Loading database");
            if (ready && prompt("Save before changing database?")) {
                await TreeTab.saveDatabase();
                lockEvents("Loading database");
            }
            await TreeTab.close();
            let _files = Array.from(folderInput[0].files);
            await TreeTab.files.init(_files);
            await TreeTab.redrawTree();
            ready = true;
            unlockEvents();
        });
        saveButton.on('click', async () => {
            if (eventLocked)
                return;
            lockEvents("Saving database (this might take some time on larger database)");
            await TreeTab.saveDatabase();
            unlockEvents();
        });
        searchInput.on('keyup', () => {
            if (!tree)
                return;
            if (to)
                clearTimeout(to);
            to = setTimeout(function () {
                let v = searchInput.val();
                tree.search(v);
            }, 250);
        });
        unlockEvents();
    }
    static async saveDatabase() {
        lockEvents("Archiving database (this might take some time on larger database)");
        await TreeTab.close();
        lockEvents("Preparing download (if this step takes too long, something might b wrong with your device)");
        await TreeTab.files.save();
    }
    static async redrawTree() {
        if (tree)
            tree.destroy(false);
        saveButton.prop("disabled", true);
        searchInput.prop("disabled", true);
        tree = treeBase.jstree({
            core: {
                data: await TreeTab.files.treeData(),
                error: console.error,
                multiple: false,
            },
            types: {
                json: {
                    icon: "assets/json.png",
                    max_children: 0
                }
            },
            search: {
                show_only_matches: true,
                show_only_matches_children: true
            },
            plugins: ["search", "types", "wholerow"]
        }).jstree(true);
        TreeTab.createEvents();
        saveButton.prop("disabled", false);
        searchInput.prop("disabled", false);
    }
    static async save() {
        try {
            if (!curPath.length)
                return;
            let curData = await EditorTab_1.EditorTab.getData();
            if (!equal(curData, prevData, { strict: true })) {
                if (!await TreeTab.database.tryApplyChanges(prevData, curData, this.files)) {
                    return;
                }
                let curDataStr = JSON.stringify(curData);
                await TreeTab.files.writeFile(curPath, curDataStr);
            }
        }
        catch (e) {
            return;
        }
    }
    static async close() {
        await TreeTab.save();
        EditorTab_1.EditorTab.closeAll();
    }
    static createEvents() {
        treeBase.on('changed.jstree', async function (e, data) {
            var _a;
            if (eventLocked)
                return;
            if (((_a = data === null || data === void 0 ? void 0 : data.node) === null || _a === void 0 ? void 0 : _a.type) !== "json")
                return;
            lockEvents("Saving current file.");
            await TreeTab.save();
            curPath = await TreeTab.files.getPathFromSelection(data.selected);
            let selected = await TreeTab.files.readFile(curPath);
            prevData = JSON.parse(selected);
            lockEvents("Opening new file.");
            EditorTab_1.EditorTab.feedData(prevData);
            unlockEvents();
        });
    }
}
exports.TreeTab = TreeTab;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHJlZVRhYi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlRyZWVUYWIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNEJBQTRCO0FBRTVCLDJDQUFzQztBQUd0QyxvQ0FBcUM7QUFFckMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRWxCLElBQUksUUFBZ0IsQ0FBQTtBQUNwQixJQUFJLElBQVksQ0FBQztBQUNqQixJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFDakIsSUFBSSxRQUFzQixDQUFDO0FBQzNCLElBQUksV0FBb0IsQ0FBQztBQUN6QixJQUFJLEVBQU8sQ0FBQztBQUNaLElBQUksV0FBcUMsQ0FBQztBQUMxQyxJQUFJLFVBQW9DLENBQUM7QUFDekMsSUFBSSxXQUFxQyxDQUFDO0FBQzFDLElBQUksS0FBSyxHQUFHLEtBQUssQ0FBQztBQUNsQixJQUFJLEtBQTBCLENBQUM7QUFFL0IsSUFBSSxVQUFVLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBRTtJQUM5QixLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsR0FBQyxJQUFJLENBQUM7SUFDdEMsSUFBSSxXQUFXLEVBQUU7UUFDYixPQUFPO0tBQ1Y7SUFDRCxXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQ25CLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDcEIsQ0FBQyxDQUFBO0FBRUQsSUFBSSxZQUFZLEdBQUcsR0FBRyxFQUFFO0lBQ3BCLElBQUksQ0FBQyxXQUFXO1FBQUUsT0FBTztJQUN6QixXQUFXLEdBQUcsS0FBSyxDQUFDO0lBQ3BCLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDcEIsQ0FBQyxDQUFBO0FBRUQsTUFBYSxPQUFPO0lBSVQsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFZLEVBQUUsUUFBa0I7UUFDL0MsS0FBSyxHQUFHLENBQUMsQ0FBQyxnRUFBZ0UsQ0FBQyxD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T0FBTztZQUN4QixJQUFJLENBQUEsTUFBQSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsSUFBSSwwQ0FBRSxJQUFJLE1BQUssTUFBTTtnQkFBRSxPQUFPO1lBQ3hDLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1lBQ25DLE1BQU0sT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3JCLE9BQU8sR0FBRyxNQUFNLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2xFLElBQUksUUFBUSxHQUFHLE1BQU0sT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDckQsUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDaEMsVUFBVSxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFDaEMscUJBQVMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDN0IsWUFBWSxFQUFFLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUFqSUQsMEJBaUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgJCBmcm9tIFwianF1ZXJ5XCI7XHJcbmltcG9ydCB7RmlsZXN9IGZyb20gXCIuLi9maWxlc1wiO1xyXG5pbXBvcnQge0VkaXRvclRhYn0gZnJvbSBcIi4vRWRpdG9yVGFiXCI7XHJcbmltcG9ydCB7RGF0YWJhc2VGaWxlfSBmcm9tIFwiLi4vdHlwZXNcIjtcclxuaW1wb3J0IHtEYXRhYmFzZX0gZnJvbSBcIi4uL2RhdGFiYXNlXCI7XHJcbmltcG9ydCBlcXVhbCA9IHJlcXVpcmUoXCJkZWVwLWVxdWFsXCIpO1xyXG5cclxucmVxdWlyZShcImpzdHJlZVwiKTtcclxuXHJcbmxldCB0cmVlQmFzZTogSlF1ZXJ5XHJcbmxldCB0cmVlOiBKU1RyZWU7XHJcbmxldCBjdXJQYXRoID0gXCJcIjtcclxubGV0IHByZXZEYXRhOiBEYXRhYmFzZUZpbGU7XHJcbmxldCBldmVudExvY2tlZDogYm9vbGVhbjtcclxubGV0IHRvOiBhbnk7XHJcbmxldCBmb2xkZXJJbnB1dDogSlF1ZXJ5PEhUTUxJbnB1dEVsZW1lbnQ+O1xyXG5sZXQgc2F2ZUJ1dHRvbjogSlF1ZXJ5PEhUTUxJbnB1dEVsZW1lbnQ+O1xyXG5sZXQgc2VhcmNoSW5wdXQ6IEpRdWVyeTxIVE1MSW5wdXRFbGVtZW50PjtcclxubGV0IHJlYWR5ID0gZmFsc2U7XHJcbmxldCBjb3ZlcjogSlF1ZXJ5PEhUTUxFbGVtZW50PjtcclxuXHJcbmxldCBsb2NrRXZlbnRzID0gKHRleHQ6IHN0cmluZykgPT4ge1xyXG4gICAgY292ZXIuZmluZChcImRpdlwiKVswXS50ZXh0Q29udGVudD10ZXh0O1xyXG4gICAgaWYgKGV2ZW50TG9ja2VkKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgZXZlbnRMb2NrZWQgPSB0cnVlO1xyXG4gICAgY292ZXIuc2hvdygwLjUpO1xyXG59XHJcblxyXG5sZXQgdW5sb2NrRXZlbnRzID0gKCkgPT4ge1xyXG4gICAgaWYgKCFldmVudExvY2tlZCkgcmV0dXJuO1xyXG4gICAgZXZlbnRMb2NrZWQgPSBmYWxzZTtcclxuICAgIGNvdmVyLmhpZGUoMC41KTtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFRyZWVUYWIge1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZmlsZXM6IEZpbGVzO1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZGF0YWJhc2U6IERhdGFiYXNlO1xyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgaW5pdChmaWxlczogRmlsZXMsIGRhdGFiYXNlOiBEYXRhYmFzZSkge1xyXG4gICAgICAgIGNvdmVyID0gJChgPGRpdiBjbGFzcz1cImNvdmVyXCI+PGRpdj48L2Rpdj48ZGl2IGNsYXNzPVwibG9hZGVyXCI+PC9kaXY+PC9kaXY+YCk7XHJcbiAgICAgICAgJChcImJvZHlcIikuYXBwZW5kKGNvdmVyKTtcclxuICAgICAgICBsb2NrRXZlbnRzKFwiRWRpdG9yIGlzIHN0YXJ0aW5nXCIpO1xyXG4gICAgICAgIFRyZWVUYWIuZmlsZXMgPSBmaWxlcztcclxuICAgICAgICBUcmVlVGFiLmRhdGFiYXNlID0gZGF0YWJhc2U7XHJcbiAgICAgICAgbGV0IGhvbGRlciA9ICQoXCIjdHJlZUhvbGRlclwiKTtcclxuICAgICAgICBsZXQgcjEgPSAkKFwiPGRpdiBjbGFzcz0ncjEnPjwvZGl2PlwiKTtcclxuICAgICAgICBsZXQgcjIgPSAkKFwiPGRpdiBjbGFzcz0ncjInPjwvZGl2PlwiKTtcclxuICAgICAgICBob2xkZXIuYXBwZW5kKHIxKTtcclxuICAgICAgICBob2xkZXIuYXBwZW5kKHIyKTtcclxuICAgICAgICBmb2xkZXJJbnB1dCA9ICQoYDxpbnB1dCB0eXBlPVwiZmlsZVwiIHdlYmtpdGRpcmVjdG9yeSBtdWx0aXBsZT5gKTtcclxuICAgICAgICBzYXZlQnV0dG9uID0gJChgPGlucHV0IHR5cGU9XCJidXR0b25cIiB2YWx1ZT1cIlNhdmUgZGF0YWJhc2VcIj5gKTtcclxuICAgICAgICBsZXQgc2VhcmNoTGFiZWwgPSAkKGA8bGFiZWwgZm9yPVwidHJlZS1zZWFyY2hcIj5TZWFyY2g6IDwvbGFiZWw+YClcclxuICAgICAgICBzZWFyY2hJbnB1dCA9ICQoYDxpbnB1dCBpZD1cInRyZWUtc2VhcmNoXCIgdHlwZT1cInNlYXJjaFwiPmApO1xyXG4gICAgICAgIHIxLmFwcGVuZChmb2xkZXJJbnB1dCk7XHJcbiAgICAgICAgcjEuYXBwZW5kKHNhdmVCdXR0b24pO1xyXG4gICAgICAgIHIyLmFwcGVuZChzZWFyY2hMYWJlbCk7XHJcbiAgICAgICAgcjIuYXBwZW5kKHNlYXJjaElucHV0KTtcclxuICAgICAgICBzYXZlQnV0dG9uLnByb3AoXCJkaXNhYmxlZFwiLCB0cnVlKTtcclxuICAgICAgICBzZWFyY2hJbnB1dC5wcm9wKFwiZGlzYWJsZWRcIiwgdHJ1ZSk7XHJcbiAgICAgICAgdHJlZUJhc2UgPSAkKGA8ZGl2PjwvZGl2PmApO1xyXG4gICAgICAgIGhvbGRlci5hcHBlbmQodHJlZUJhc2UpO1xyXG4gICAgICAgIGZvbGRlcklucHV0Lm9uKFwiY2hhbmdlXCIsIGFzeW5jIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnRMb2NrZWQpIHJldHVybjtcclxuICAgICAgICAgICAgbG9ja0V2ZW50cyhcIkxvYWRpbmcgZGF0YWJhc2VcIik7XHJcbiAgICAgICAgICAgIGlmIChyZWFkeSAmJiBwcm9tcHQoXCJTYXZlIGJlZm9yZSBjaGFuZ2luZyBkYXRhYmFzZT9cIikpIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IFRyZWVUYWIuc2F2ZURhdGFiYXNlKCk7XHJcbiAgICAgICAgICAgICAgICBsb2NrRXZlbnRzKFwiTG9hZGluZyBkYXRhYmFzZVwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBhd2FpdCBUcmVlVGFiLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIGxldCBfZmlsZXMgPSBBcnJheS5mcm9tKGZvbGRlcklucHV0WzBdLmZpbGVzIGFzIEZpbGVMaXN0KTtcclxuICAgICAgICAgICAgYXdhaXQgVHJlZVRhYi5maWxlcy5pbml0KF9maWxlcyk7XHJcbiAgICAgICAgICAgIGF3YWl0IFRyZWVUYWIucmVkcmF3VHJlZSgpO1xyXG4gICAgICAgICAgICByZWFkeSA9IHRydWU7XHJcbiAgICAgICAgICAgIHVubG9ja0V2ZW50cygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNhdmVCdXR0b24ub24oJ2NsaWNrJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnRMb2NrZWQpIHJldHVybjtcclxuICAgICAgICAgICAgbG9ja0V2ZW50cyhcIlNhdmluZyBkYXRhYmFzZSAodGhpcyBtaWdodCB0YWtlIHNvbWUgdGltZSBvbiBsYXJnZXIgZGF0YWJhc2UpXCIpO1xyXG4gICAgICAgICAgICBhd2FpdCBUcmVlVGFiLnNhdmVEYXRhYmFzZSgpO1xyXG4gICAgICAgICAgICB1bmxvY2tFdmVudHMoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBzZWFyY2hJbnB1dC5vbigna2V5dXAnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghdHJlZSkgcmV0dXJuO1xyXG4gICAgICAgICAgICBpZiAodG8pIGNsZWFyVGltZW91dCh0byk7XHJcbiAgICAgICAgICAgIHRvID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgdiA9IHNlYXJjaElucHV0LnZhbCgpIGFzIHN0cmluZztcclxuICAgICAgICAgICAgICAgIHRyZWUuc2VhcmNoKHYpO1xyXG4gICAgICAgICAgICB9LCAyNTApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHVubG9ja0V2ZW50cygpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgc2F2ZURhdGFiYXNlKCkge1xyXG4gICAgICAgIGxvY2tFdmVudHMoXCJBcmNoaXZpbmcgZGF0YWJhc2UgKHRoaXMgbWlnaHQgdGFrZSBzb21lIHRpbWUgb24gbGFyZ2VyIGRhdGFiYXNlKVwiKTtcclxuICAgICAgICBhd2FpdCBUcmVlVGFiLmNsb3NlKCk7XHJcblxyXG4gICAgICAgIGxvY2tFdmVudHMoXCJQcmVwYXJpbmcgZG93bmxvYWQgKGlmIHRoaXMgc3RlcCB0YWtlcyB0b28gbG9uZywgc29tZXRoaW5nIG1pZ2h0IGIgd3Jvbmcgd2l0aCB5b3VyIGRldmljZSlcIik7XHJcbiAgICAgICAgYXdhaXQgVHJlZVRhYi5maWxlcy5zYXZlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyByZWRyYXdUcmVlKCkge1xyXG4gICAgICAgIGlmICh0cmVlKSB0cmVlLmRlc3Ryb3koZmFsc2UpO1xyXG4gICAgICAgIHNhdmVCdXR0b24ucHJvcChcImRpc2FibGVkXCIsIHRydWUpO1xyXG4gICAgICAgIHNlYXJjaElucHV0LnByb3AoXCJkaXNhYmxlZFwiLCB0cnVlKTtcclxuICAgICAgICB0cmVlID0gdHJlZUJhc2UuanN0cmVlKHtcclxuICAgICAgICAgICAgY29yZToge1xyXG4gICAgICAgICAgICAgICAgZGF0YTogYXdhaXQgVHJlZVRhYi5maWxlcy50cmVlRGF0YSgpLFxyXG4gICAgICAgICAgICAgICAgZXJyb3I6IGNvbnNvbGUuZXJyb3IsXHJcbiAgICAgICAgICAgICAgICBtdWx0aXBsZTogZmFsc2UsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHR5cGVzOiB7XHJcbiAgICAgICAgICAgICAgICBqc29uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWNvbjogXCJhc3NldHMvanNvbi5wbmdcIixcclxuICAgICAgICAgICAgICAgICAgICBtYXhfY2hpbGRyZW46IDBcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc2VhcmNoOiB7XHJcbiAgICAgICAgICAgICAgICBzaG93X29ubHlfbWF0Y2hlczogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIHNob3dfb25seV9tYXRjaGVzX2NoaWxkcmVuOiB0cnVlXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHBsdWdpbnM6IFtcInNlYXJjaFwiLCBcInR5cGVzXCIsIFwid2hvbGVyb3dcIl1cclxuICAgICAgICB9IGFzIEpTVHJlZVN0YXRpY0RlZmF1bHRzKS5qc3RyZWUodHJ1ZSk7XHJcbiAgICAgICAgVHJlZVRhYi5jcmVhdGVFdmVudHMoKTtcclxuICAgICAgICBzYXZlQnV0dG9uLnByb3AoXCJkaXNhYmxlZFwiLCBmYWxzZSk7XHJcbiAgICAgICAgc2VhcmNoSW5wdXQucHJvcChcImRpc2FibGVkXCIsIGZhbHNlKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIHNhdmUoKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKCFjdXJQYXRoLmxlbmd0aCkgcmV0dXJuO1xyXG4gICAgICAgICAgICBsZXQgY3VyRGF0YTogRGF0YWJhc2VGaWxlID0gYXdhaXQgRWRpdG9yVGFiLmdldERhdGEoKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghZXF1YWwoY3VyRGF0YSwgcHJldkRhdGEsIHtzdHJpY3Q6IHRydWV9KSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFhd2FpdCBUcmVlVGFiLmRhdGFiYXNlLnRyeUFwcGx5Q2hhbmdlcyhwcmV2RGF0YSwgY3VyRGF0YSwgdGhpcy5maWxlcykpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBsZXQgY3VyRGF0YVN0ciA9IEpTT04uc3RyaW5naWZ5KGN1ckRhdGEpO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgVHJlZVRhYi5maWxlcy53cml0ZUZpbGUoY3VyUGF0aCwgY3VyRGF0YVN0cik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBjbG9zZSgpIHtcclxuICAgICAgICBhd2FpdCBUcmVlVGFiLnNhdmUoKTtcclxuICAgICAgICBFZGl0b3JUYWIuY2xvc2VBbGwoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGNyZWF0ZUV2ZW50cygpIHtcclxuICAgICAgICB0cmVlQmFzZS5vbignY2hhbmdlZC5qc3RyZWUnLCBhc3luYyBmdW5jdGlvbiAoZSwgZGF0YSkge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnRMb2NrZWQpIHJldHVybjtcclxuICAgICAgICAgICAgaWYgKGRhdGE/Lm5vZGU/LnR5cGUgIT09IFwianNvblwiKSByZXR1cm47XHJcbiAgICAgICAgICAgIGxvY2tFdmVudHMoXCJTYXZpbmcgY3VycmVudCBmaWxlLlwiKTtcclxuICAgICAgICAgICAgYXdhaXQgVHJlZVRhYi5zYXZlKCk7XHJcbiAgICAgICAgICAgIGN1clBhdGggPSBhd2FpdCBUcmVlVGFiLmZpbGVzLmdldFBhdGhGcm9tU2VsZWN0aW9uKGRhdGEuc2VsZWN0ZWQpO1xyXG4gICAgICAgICAgICBsZXQgc2VsZWN0ZWQgPSBhd2FpdCBUcmVlVGFiLmZpbGVzLnJlYWRGaWxlKGN1clBhdGgpO1xyXG4gICAgICAgICAgICBwcmV2RGF0YSA9IEpTT04ucGFyc2Uoc2VsZWN0ZWQpO1xyXG4gICAgICAgICAgICBsb2NrRXZlbnRzKFwiT3BlbmluZyBuZXcgZmlsZS5cIik7XHJcbiAgICAgICAgICAgIEVkaXRvclRhYi5mZWVkRGF0YShwcmV2RGF0YSk7XHJcbiAgICAgICAgICAgIHVubG9ja0V2ZW50cygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59Il19